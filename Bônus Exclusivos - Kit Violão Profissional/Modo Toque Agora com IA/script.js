// Banco de dados de cifras, ritmos e missões para o Modo Toque Agora com IA
const database = {
    cifras: [
        {
            title: "Wonderwall",
            artist: "Oasis",
            genre: "Rock",
            tonality: "Mi menor",
            difficulty: "Iniciante",
            preview: `Em7   G    Dsus4   A7sus4
Hoje vai ser o dia que eles vão jogar de volta para você
Em7       G     Dsus4    A7sus4
Por agora você deveria de alguma forma ter percebido o que tem que fazer`,
            full: `Em7   G    Dsus4   A7sus4
Hoje vai ser o dia que eles vão jogar de volta para você
Em7       G     Dsus4    A7sus4
Por agora você deveria de alguma forma ter percebido o que tem que fazer
Em7 G Dsus4 A7sus4
Eu não acredito que alguém sinta do jeito que eu sinto sobre você agora

Capo na 2ª Casa

Em7:      022033
G:        320033
Dsus4:    xx0233
A7sus4:   x02033

[Intro] Em7 G Dsus4 A7sus4 (2x)

[Verso 1]
Em7                G
Hoje vai ser o dia 
          Dsus4                      A7sus4
Que eles vão jogar de volta para você
Em7               G
Por agora você 
           Dsus4                        A7sus4
Deveria de alguma forma ter percebido o que tem que fazer

[Refrão]
Em7      G
Eu não acredito 
       Dsus4                      A7sus4
Que alguém sinta do jeito que eu sinto 
Em7      G
Sobre você agora
...`
        },
        {
            title: "Trem-Bala",
            artist: "Ana Vilela",
            genre: "MPB",
            tonality: "Sol Maior",
            difficulty: "Iniciante",
            preview: `G   D/F#   Em   C   G   D   Em   C
Não é sobre ter todas as pessoas do mundo pra si
É sobre saber que em algum lugar alguém zela por ti`,
            full: `[Intro] G D/F# Em C G D Em C

[Verso 1]
G                 D/F#            Em
Não é sobre ter todas as pessoas do mundo pra si
C             G                 D                Em           C
É sobre saber que em algum lugar alguém zela por ti
G                 D/F#                Em
É sobre cantar e poder escutar mais do que a própria voz
C             G           D            Em         C
É sobre dançar na chuva de vida que cai sobre nós

[Refrão]
G                D/F#
É saber se sentir infinito
Em               C
Num universo tão vasto e bonito
G                 D
É saber sonhar e, então, fazer valer
Em                  C
A pena cada verso daquele poema sobre acreditar

[Verso 2]
G              D/F#            Em
Não é sobre chegar no topo do mundo e saber que venceu
C            G           D               Em         C
É sobre escalar e sentir que o caminho te fortaleceu
G                         D/F#                 Em
É sobre ser abrigo e também ter morada em outros corações
C                G                D                Em           C
E assim ter amigos contigo em todas as situações

[Refrão]
G                D/F#
A gente não pode ter tudo
Em               C
Qual seria a graça do mundo se fosse assim?
G                 D
Por isso, eu prefiro sorrisos
Em                  C
E os presentes que a vida trouxe pra perto de mim

[Ponte]
Am         C/G              D          G     Em
Não é sobre tudo que o seu dinheiro é capaz de comprar
Am              C/G                  D
E sim sobre cada momento, sorriso a se compartilhar
Am        C/G             D            G     Em
Também não é sobre correr contra o tempo pra ter sempre mais
        Am                C/G                 D
Porque quando menos se espera a vida já ficou pra trás

[Final]
G                 D/F#             Em
Segura teu filho no colo, sorria e abraça os teus pais
C           G            D               Em             C
Enquanto estão aqui, que a vida é trem-bala, parceiro, e a gente é só passageiro prestes a partir

G   D/F#   Em   C
G   D      Em   C

G     D/F#      Em     C
Laiá, laiá, laiá, laiá, laiá
G     D        Em     C
Laiá, laiá, laiá, laiá, laiá

G Dsus4 G

Cifra:
G:      320003
D/F#:   200232
Em:     022000
C:      032010
Am:     002210
C/G:    332010
Dsus4:  xx0233`
        },
        {
            title: "Perfect",
            artist: "Ed Sheeran",
            genre: "Pop",
            tonality: "Dó Maior",
            difficulty: "Intermediário",
            preview: `G   Em   C   D   G   Em   C   D
Eu encontrei um amor para mim
Querida, apenas mergulhe e me siga`,
            full: `[Intro] G Em C D (2x)

[Verso 1]
G                          Em
Eu encontrei um amor para mim
                C                    D
Querida, apenas mergulhe e me siga
G                         Em
Eu encontrei uma garota linda e doce
           C                                D
Oh, eu nunca soube que você era o alguém esperando por mim

[Pré-Refrão]
G                                     Em
Porque nós éramos apenas crianças quando nos apaixonamos
             C                            D                  G
Sem saber o que era, eu não vou desistir de você desta vez
                           Em
Mas querida, apenas me beije devagar
            C                                D
Seu coração é tudo o que possuo, e seu sorriso é a minha casa

[Refrão]
         G                Em
Quando você olha nos meus olhos
          C                     D                    G
Querida, você me segura nos seus braços, Baby, eu estou dançando no escuro
                       Em                   C
Com você entre meus braços, Descalço na grama
           D                     G
Ouvindo nossa canção favorita, quando você disse que estava bagunçada
      Em              C
Eu sussurrei por baixo da respiração
        D                       G
Mas você me ouviu, querida, você parece perfeita essa noite

[Instrumental] G Em C D G

[Verso 2]
G                             Em
Bem, eu encontrei uma mulher, mais forte do que qualquer um que eu conheço
                C                         D
Ela compartilha meus sonhos, espero que algum dia compartilhe sua casa
G                         Em
Encontrei um amor, para carregar mais que apenas meus segredos
             C                                 D
Para carregar amor, para carregar nossas crianças, nós ainda somos crianças
                G
Mas nós estamos apaixonados
                          Em
Lutando contra todas as probabilidades
                 C                    D
Eu sei que ficaremos bem desta vez

[Refrão]
         G                Em
Quando você olha nos meus olhos
          C                     D                    G
Querida, você me segura nos seus braços, Baby, eu estou dançando no escuro
                       Em                   C
Com você entre meus braços, Descalço na grama
           D                     G
Ouvindo nossa canção favorita, quando eu te vi naquele vestido
               Em             C
Tão linda, não merece isso, querida
        D                       G
Você parece perfeita essa noite

[Instrumental] G Em C D

[Refrão]
         G                Em
Quando você olha nos meus olhos
          C                     D                    G
Querida, você me segura nos seus braços, Baby, eu estou dançando no escuro
                       Em                   C
Com você entre meus braços, Descalço na grama
           D                     G    Em
Ouvindo nossa canção favorita, eu tenho fé
                C        
No que estou vendo
            D                     Em
Agora eu sei que encontrei uma mulher
         C                   D
Além dos meus sonhos mais loucos
        Em                      C
E ela é perfeita, não mereço isso
        D                       G
Você parece perfeita essa noite

Cifras:
G:  320003
Em: 022000
C:  032010
D:  xx0232`
        },
        {
            title: "Evidências",
            artist: "Chitãozinho e Xororó",
            genre: "Sertanejo",
            tonality: "Ré Maior",
            difficulty: "Intermediário",
            preview: `G   C/G   D/F#   Em7   C   G   D
Quando eu digo que deixei de te amar
É porque eu te amo
Quando eu digo que não quero mais você
É porque eu te quero`,
            full: `[Intro] G C/G D/F# Em7 C G D

[Verso 1]
G          C
Quando eu digo que deixei de te amar
D           G
É porque eu te amo
G             C
Quando eu digo que não quero mais você
D           G
É porque eu te quero

[Refrão]
D                  C
Eu tenho medo de te dar meu coração
        Em                 D
E confessar que não sei viver sem teu amor
G           C
Eu preciso de você
D         G - D7
Meu amor, escute bem!

[Verso 2]
G            C
Quando eu digo que deixei de te amar
D          G
É porque eu te amo
G           C
Quando eu digo: "Não quero mais você"
D         G
É porque eu te quero

[Pré-refrão]
D                            C
São só palavras e o que eu sinto mesmo
          Em
É que eu não consigo é ficar sem você
         D
O teu amor é tudo
                G - D7
Que eu preciso para viver

[Instrumental] G C D G

[Verso 3]
G
Por mais que eu tenha esquecido você
C
Por mais que eu tenha outro alguém
D
Quando lembro
G       D7
Eu só penso em você
G
Por mais que eu diga
C
Que não te amo mais
                 D
No fundo, no fundo
                G - D7
Eu sei que isso não é capaz

[Refrão]
D                  C
Eu tenho medo de te dar meu coração
        Em              D            G
E confessar que não sei viver sem teu amor
            C
Nós temos tudo
             D             G
Basta apenas acreditar
              C
Tem tantas coisas
             D          G
Que eu quero te mostrar
     D7          G
Evidências do amor

Cifras:
G:    320003
C:    032010
D:    xx0232
D/F#: 200232
Em7:  022030
D7:   xx0212`
        },
        {
            title: "Photograph",
            artist: "Ed Sheeran",
            genre: "Pop",
            tonality: "Sol Maior",
            difficulty: "Intermediário",
            preview: `G   Em   C   D   G   Em   C   D   Em
Amando pode machucar, amando pode ferir às vezes
Mas é a única coisa que eu sei`,
            full: `[Intro] G Em C D G Em C D Em

[Verso 1]
       G                     Em
Amando pode machucar, amando pode ferir às vezes
        C                     D               Em
Mas é a única coisa que eu sei, quando fica difícil
           G                 Em
Você sabe que pode ficar ruim às vezes
          C                  D               Em
É a única coisa que nos faz sentir vivos

[Pré-refrão]
         D                   Em
Nós mantemos esse amor em uma fotografia
         D                    Em
Fizemos essas memórias para nós mesmos
         D                 Em
Onde nossos olhos nunca se fecham
        D                    C
Nossos corações estavam nunca quebrados
          D/F#              G
E nosso tempo está congelado para sempre

[Refrão]
          C                G              D        Em
Então me mantenha dentro do bolso do seu jeans rasgado
          C             G           D        Em
Me segure perto até os olhos se encontrarem
           C              G             D       Em
Você não vai me ver estando sozinho, só espere por mim 
       C        G         D
Para voltar para casa

[Ponte] Em Em/D C D

[Verso 2]
       G                     Em
Amando pode curar, amando pode costurar sua soul
         C                    D             Em
É a única coisa que eu sei, eu juro que é verdade
             G            Em
Aprender a amar os arranhões
         C                       D                 Em
De toda a sua superfície, nós simplesmente precisamos de tempo
          G                   Em
Eu vou ser seu fotógrafo, você vai ser nossa canção
         C                    D                 Em
Quando as pernas não funcionarem como costumavam fazer antes

[Pré-refrão]
         D                   Em
Nós mantemos esse amor em uma fotografia
         D                    Em
Fizemos essas memórias para nós mesmos
         D                 Em
Onde nossos olhos nunca se fecham
        D                    C
Nossos corações estavam nunca quebrados
          D/F#              G
E nosso tempo está congelado para sempre

[Refrão]
          C                G              D        Em
Então me mantenha dentro do bolso do seu jeans rasgado
          C             G           D        Em
Me segure perto até os olhos se encontrarem
           C              G             D       Em
Você não vai me ver estando sozinho, só espere por mim 
       C        G         D
Para voltar para casa

[Bridge]
     C        G          D
Para voltar para casa, para voltar para casa
     C        G          D       Em
Para voltar para casa, para voltar para casa
           C             G             D        Em
Você não vai me ver estando sozinho, só espere por mim 
       C        G         D        Em   C   G   D   Em
Para voltar para casa

[Outro]
        C              G             D       Em
Eu sei que você espera por mim para voltar para casa

Cifras principais:
G:     320003
Em:    022000
C:     032010
D:     xx0232
D/F#:  200232
Em/D:  020000`
        }
    ],
    ritmos: [
        {
            name: "Pop Básico",
            notation: "↓ ↓ ↑↓ ↑↓",
            description: "Ritmo simples usado em músicas pop e rock lento. Funciona bem com músicas em 4/4. Bata para baixo duas vezes, depois faça a sequência 'baixo-cima' duas vezes.",
            bpm: 80
        },
        {
            name: "Bossa Nova Simplificada",
            notation: "↓ ↓ ↑ ↓ ↑",
            description: "Adaptação simplificada do ritmo de Bossa Nova. Foque em manter a marcação regular e fluida, tornando-se quase suave. Perfeito para músicas mais tranquilas.",
            bpm: 70
        },
        {
            name: "Sertanejo Universitário",
            notation: "↓ ↓↑ ↓ ↓↑",
            description: "Ritmo animado típico do sertanejo universitário. A segunda batida pra baixo é seguida imediatamente por uma batida para cima, criando um efeito sincopado.",
            bpm: 90
        },
        {
            name: "Balada",
            notation: "↓ ↓ ↓ ↓",
            description: "Ritmo simples de balada, perfeito para músicas lentas e emotivas. Mantenha todas as batidas para baixo, acentuando o primeiro tempo para criar dinâmica.",
            bpm: 65
        },
        {
            name: "Reggae Simplificado",
            notation: "↓ ↑ ↓ ↑",
            description: "Versão simplificada do ritmo reggae. A chave está em abafar as cordas com a palma da mão entre cada batida, criando o efeito característico 'chicka' do estilo.",
            bpm: 75
        }
    ],
    missoes: [
        {
            title: "Transições Rápidas",
            description: "Pratique a transição rápida entre os acordes principais da música, focando na precisão e velocidade. O objetivo é conseguir mudar de um acorde para outro sem pausas ou hesitações.",
            steps: [
                "Identifique os 3-4 acordes principais da música escolhida",
                "Pratique a transição entre cada par de acordes por 5 vezes",
                "Aumente gradualmente a velocidade conforme se sentir confortável",
                "Tente tocar a sequência completa de acordes sem parar"
            ],
            timeInMinutes: 15
        },
        {
            title: "Consistência Rítmica",
            description: "Trabalhe na manutenção de um ritmo consistente, mesmo durante as trocas de acordes. Use um metrônomo para garantir que você mantenha o tempo correto durante toda a prática.",
            steps: [
                "Configure um metrônomo para um tempo confortável",
                "Pratique o ritmo escolhido apenas com acordes simples",
                "Vá aumentando a velocidade conforme estiver confortável",
                "Adicione trocas de acordes mantendo o ritmo constante"
            ],
            timeInMinutes: 20
        },
        {
            title: "Expressividade na Mão Direita",
            description: "Desenvolva maior controle e expressividade com a mão direita, trabalhando dinâmicas (forte/fraco) e acentuações rítmicas. Isso dará mais vida às suas execuções.",
            steps: [
                "Pratique o ritmo proposto alternando partes mais fortes e mais suaves",
                "Experimente acentuar diferentes tempos do compasso",
                "Tente criar variações sutis no ritmo básico",
                "Aplique as dinâmicas na música escolhida"
            ],
            timeInMinutes: 15
        },
        {
            title: "Dedilhado Simples",
            description: "Desenvolva um dedilhado básico para acompanhar a música escolhida, usando os dedos polegar, indicador e médio para criar um acompanhamento mais melódico.",
            steps: [
                "Pratique o padrão p-i-m nas cordas soltas",
                "Aplique o dedilhado nos acordes da música",
                "Tente manter um tempo constante sem interrupções",
                "Adicione pequenas variações ao padrão básico"
            ],
            timeInMinutes: 20
        },
        {
            title: "Cantar e Tocar",
            description: "Desafie-se a cantar enquanto toca o acompanhamento. Comece devagar, focando em manter o ritmo constante enquanto canta partes da letra.",
            steps: [
                "Memorize a sequência de acordes até que fique automática",
                "Comece cantarolando apenas o refrão enquanto toca",
                "Pratique versos curtos, um de cada vez",
                "Tente juntar tudo, mantendo o ritmo constante"
            ],
            timeInMinutes: 25
        },
        // Novos desafios adicionados
        {
            title: "Palhetada Alternada",
            description: "Desenvolva a técnica de palhetada alternada (para baixo e para cima) para melhorar a velocidade e precisão da mão direita, uma técnica essencial para diversos estilos musicais.",
            steps: [
                "Pratique a palhetada alternada (↓↑) em uma única corda com tempo lento",
                "Aumente gradualmente a velocidade mantendo a precisão rítmica",
                "Experimente aplicar a técnica em escalas simples",
                "Integre a palhetada alternada no ritmo da música escolhida"
            ],
            timeInMinutes: 18
        },
        {
            title: "Acordes com Pestana",
            description: "Trabalhe especificamente nos acordes com pestana, melhorando a força e posição do dedo indicador para conseguir pressionar todas as cordas de forma clara e limpa.",
            steps: [
                "Pratique a posição da pestana isoladamente, sem formar acordes completos",
                "Adicione os outros dedos para formar o acorde completo",
                "Verifique cada corda individualmente para garantir que todas soem claramente",
                "Pratique a transição entre acordes com pestana e acordes abertos"
            ],
            timeInMinutes: 20
        },
        {
            title: "Melodia e Harmonia",
            description: "Trabalhe na técnica de tocar a melodia da música enquanto mantém a harmonia, combinando notas individuais com acordes para criar um arranjo mais completo.",
            steps: [
                "Identifique as notas principais da melodia da música",
                "Pratique tocar essas notas isoladamente",
                "Adicione acordes básicos nos tempos fortes enquanto mantém a melodia",
                "Una tudo em um arranjo fluido, alternando entre melodia e acordes"
            ],
            timeInMinutes: 25
        },
        {
            title: "Staccato e Ligado",
            description: "Desenvolva as técnicas de staccato (notas curtas e destacadas) e ligado (notas conectadas) para adicionar expressão e dinâmica à sua execução.",
            steps: [
                "Pratique tocar notas em staccato, cortando o som logo após tocar",
                "Experimente a técnica de ligado (hammer-on e pull-off)",
                "Alterne entre as duas técnicas em uma sequência simples",
                "Aplique estas técnicas em trechos da música escolhida para criar contraste"
            ],
            timeInMinutes: 15
        },
        {
            title: "Treino com Metrônomo",
            description: "Aperfeiçoe sua precisão rítmica praticando com o metrônomo em diferentes velocidades e configurações, essencial para desenvolver um senso rítmico sólido.",
            steps: [
                "Inicie com um andamento confortável, tocando exatamente no tempo do metrônomo",
                "Pratique tocar entre as batidas (subdivisão do tempo)",
                "Experimente configurar o metrônomo apenas nos tempos 2 e 4 do compasso",
                "Gradualmente diminua o volume do metrônomo mantendo o mesmo andamento"
            ],
            timeInMinutes: 15
        },
        {
            title: "Variações de Dinâmica",
            description: "Trabalhe nas variações de dinâmica (forte/piano) para dar mais expressividade à sua execução, destacando diferentes partes da música.",
            steps: [
                "Toque a mesma sequência de acordes alternando entre forte e suave",
                "Crie crescendos (aumentando gradualmente a intensidade) e diminuendos (reduzindo)",
                "Aplique dinâmicas específicas para diferentes partes da música (verso/refrão)",
                "Combine variações de dinâmica com mudanças de ritmo"
            ],
            timeInMinutes: 15
        },
        {
            title: "Percussão no Violão",
            description: "Aprenda técnicas de percussão no tampo e nas cordas do violão para enriquecer seu acompanhamento com elementos rítmicos adicionais.",
            steps: [
                "Pratique batidas simples no tampo do violão com diferentes partes da mão",
                "Experimente combinar percussão com abafamentos de cordas",
                "Integre pequenos toques percussivos entre as batidas principais",
                "Crie um padrão rítmico que combine batidas nas cordas e percussão no tampo"
            ],
            timeInMinutes: 20
        },
        {
            title: "Precisão Harmônica",
            description: "Foque na precisão harmônica, garantindo que todos os acordes soem limpos e definidos, sem cordas abafadas ou notas indesejadas.",
            steps: [
                "Toque cada acorde lentamente, verificando a clareza de cada nota",
                "Ajuste a posição dos dedos para evitar interferências em outras cordas",
                "Pratique a pressão ideal - nem muita força, nem muito leve",
                "Grave sua execução e ouça criticamente para identificar imperfeições"
            ],
            timeInMinutes: 18
        },
        {
            title: "Estudo de Escalas",
            description: "Trabalhe com escalas musicais relacionadas à tonalidade da música para desenvolver agilidade nos dedos e compreensão harmônica.",
            steps: [
                "Identifique a escala correspondente à tonalidade da música",
                "Pratique a escala ascendente e descendente em posição fixa",
                "Experimente padrões rítmicos diferentes ao tocar a escala",
                "Use notas da escala para criar pequenos solos ou ornamentos"
            ],
            timeInMinutes: 20
        },
        {
            title: "Treino de Ouvido",
            description: "Desenvolva seu ouvido musical tentando tirar trechos da música sem olhar para a cifra, um exercício valioso para qualquer músico.",
            steps: [
                "Escolha um trecho simples da música e ouça várias vezes com atenção",
                "Tente encontrar a nota inicial no violão",
                "Experimente diferentes acordes até encontrar os que combinam com o trecho",
                "Compare sua versão com a cifra original e faça ajustes"
            ],
            timeInMinutes: 25
        }
    ],
    chordDiagrams: {
        // Padrão de acordes maiores
        "G": {
            name: "G",
            positions: [3,2,0,0,0,3],
            fingers: [2,1,0,0,0,3],
            barres: []
        },
        "C": {
            name: "C",
            positions: [0,3,2,0,1,0],
            fingers: [0,3,2,0,1,0],
            barres: []
        },
        "D": {
            name: "D",
            positions: [-1,-1,0,2,3,2],
            fingers: [0,0,0,1,3,2],
            barres: []
        },
        "A": {
            name: "A",
            positions: [0,0,2,2,2,0],
            fingers: [0,0,1,2,3,0],
            barres: []
        },
        "E": {
            name: "E",
            positions: [0,2,2,1,0,0],
            fingers: [0,2,3,1,0,0],
            barres: []
        },
        "F": {
            name: "F",
            positions: [1,3,3,2,1,1],
            fingers: [1,3,4,2,1,1],
            barres: [{ fromString: 1, toString: 6, fret: 1 }]
        },
        // Acordes menores
        "Em": {
            name: "Em",
            positions: [0,2,2,0,0,0],
            fingers: [0,2,3,0,0,0],
            barres: []
        },
        "Am": {
            name: "Am",
            positions: [0,0,2,2,1,0],
            fingers: [0,0,2,3,1,0],
            barres: []
        },
        "Dm": {
            name: "Dm",
            positions: [-1,-1,0,2,3,1],
            fingers: [0,0,0,2,3,1],
            barres: []
        },
        // Acordes com 7
        "G7": {
            name: "G7",
            positions: [3,2,0,0,0,1],
            fingers: [3,2,0,0,0,1],
            barres: []
        },
        "C7": {
            name: "C7",
            positions: [0,3,2,3,1,0],
            fingers: [0,3,2,4,1,0],
            barres: []
        },
        "D7": {
            name: "D7",
            positions: [-1,-1,0,2,1,2],
            fingers: [0,0,0,2,1,3],
            barres: []
        },
        "A7": {
            name: "A7",
            positions: [0,0,2,0,2,0],
            fingers: [0,0,2,0,3,0],
            barres: []
        },
        "E7": {
            name: "E7",
            positions: [0,2,0,1,0,0],
            fingers: [0,2,0,1,0,0],
            barres: []
        },
        // Acordes específicos
        "D/F#": {
            name: "D/F#",
            positions: [2,0,0,2,3,2],
            fingers: [1,0,0,2,4,3],
            barres: []
        },
        "Em7": {
            name: "Em7",
            positions: [0,2,2,0,3,0],
            fingers: [0,1,2,0,3,0],
            barres: []
        },
        "Dsus4": {
            name: "Dsus4",
            positions: [-1,-1,0,2,3,3],
            fingers: [0,0,0,1,2,3],
            barres: []
        },
        "A7sus4": {
            name: "A7sus4",
            positions: [-1,0,2,0,3,3],
            fingers: [0,0,1,0,2,3],
            barres: []
        },
        "C/G": {
            name: "C/G",
            positions: [3,3,2,0,1,0],
            fingers: [3,4,2,0,1,0],
            barres: []
        }
    },
    rhythmTutorials: {
        "Pop Básico": {
            description: "Este ritmo é a base para muitas músicas pop e rock. É versátil e fácil de aprender, perfeito para iniciantes.",
            steps: [
                "Segure a palheta com firmeza, mas sem tensão excessiva",
                "Comece batendo para baixo duas vezes, atingindo principalmente as cordas mais graves",
                "Depois, faça duas batidas combinadas: baixo-cima, baixo-cima",
                "Mantenha um movimento fluido e constante do pulso"
            ],
            tips: [
                "Pratique lentamente com o metrônomo e aumente a velocidade gradualmente",
                "Tente manter o ritmo mesmo quando você errar, sem parar",
                "Foque na consistência do som, não na velocidade",
                "Ao tocar com acordes, concentre-se na transição entre eles sem perder o ritmo"
            ],
            animation: "↓ ↓ ↑↓ ↑↓"
        },
        "Bossa Nova Simplificada": {
            description: "Uma versão simplificada da batida de Bossa Nova, que traz a essência deste estilo brasileiro icônico de forma acessível para estudantes de violão.",
            steps: [
                "Mantenha o pulso relaxado e faça a primeira batida para baixo, acentuando levemente",
                "Faça uma segunda batida para baixo, atingindo cordas intermediárias",
                "Suba com uma batida para cima, mais leve, tocando poucas cordas",
                "Desça novamente com uma batida para baixo, e termine com uma leve batida para cima"
            ],
            tips: [
                "O segredo está na sutileza das batidas - não precisa ser forte",
                "Tente abafar levemente as cordas com a palma da mão direita entre algumas batidas",
                "O som deve fluir com suavidade, sem acentos muito fortes",
                "Pense na batida como uma onda suave que vai e volta"
            ],
            animation: "↓ ↓ ↑ ↓ ↑"
        },
        "Sertanejo Universitário": {
            description: "Um ritmo dançante e animado típico do sertanejo universitário brasileiro. A característica principal é o efeito sincopado entre as batidas.",
            steps: [
                "Comece com uma batida para baixo mais forte nas cordas graves",
                "Faça imediatamente uma sequência rápida baixo-cima (quase juntas)",
                "Batida para baixo normal",
                "Repita a sequência rápida baixo-cima para finalizar"
            ],
            tips: [
                "A chave está na velocidade da sequência baixo-cima, que deve soar quase como uma batida só",
                "Mantenha o pulso constante, como se estivesse dançando",
                "Acentue a primeira batida de cada compasso para marcar bem o tempo",
                "Pratique com músicas do estilo para pegar a 'levada' característica"
            ],
            animation: "↓ ↓↑ ↓ ↓↑"
        },
        "Balada": {
            description: "Um ritmo simples e emotivo perfeito para músicas lentas e baladas. É ideal para iniciantes pela sua simplicidade e expressividade.",
            steps: [
                "Posicione a mão com naturalidade sobre as cordas",
                "Execute quatro batidas para baixo constantes, em tempo igual",
                "Acentue levemente a primeira batida para marcar o início do compasso",
                "Mantenha o movimento suave e constante"
            ],
            tips: [
                "A expressividade vem da intensidade das batidas - varie entre mais forte e mais suave",
                "Você pode tocar mais cordas nas batidas acentuadas e menos nas outras",
                "Este ritmo permite que você se concentre na mão esquerda e nas mudanças de acordes",
                "Experimente tocar apenas as cordas graves na primeira batida e todas nas seguintes"
            ],
            animation: "↓ ↓ ↓ ↓"
        },
        "Reggae Simplificado": {
            description: "Uma adaptação simplificada do ritmo reggae, que captura a essência do estilo jamaicano com uma técnica de abafamento característica.",
            steps: [
                "Posicione a palma da mão levemente sobre as cordas para um som abafado",
                "Alterne batidas para baixo e para cima em tempo igual",
                "Após cada batida, abafe as cordas com a palma da mão",
                "Mantenha o ritmo relaxado, sem pressa ou tensão"
            ],
            tips: [
                "O abafamento é essencial: toque e abafe, toque e abafe",
                "O efeito 'chicka' típico do reggae vem justamente deste abafamento",
                "Procure não deixar as cordas soarem por muito tempo",
                "Pratique primeiro sem acordes, apenas no ritmo, e depois adicione acordes simples"
            ],
            animation: "↓ ↑ ↓ ↑"
        }
    },
    missionTips: {
        "Transições Rápidas": "Para transições de acordes mais fluidas, pense em mover todos os dedos simultaneamente em vez de um por um. Visualize o próximo formato de acorde antes de mover a mão.",
        "Consistência Rítmica": "A consistência vem com a prática lenta e metódica. Use o metrônomo em uma velocidade confortável e só aumente quando estiver totalmente dominado.",
        "Expressividade na Mão Direita": "A mão direita é sua 'voz' no violão. Experimente tocar o mesmo trecho de diferentes maneiras: suave, forte, destacado, contínuo, e ouça a diferença emocional.",
        "Dedilhado Simples": "No dedilhado, mantenha os dedos da mão direita relaxados e próximos às cordas. O polegar cuida das três cordas mais graves e os outros dedos das mais agudas.",
        "Cantar e Tocar": "O segredo para cantar e tocar é automatizar o acompanhamento. Pratique o violão até que você possa tocar 'no automático', liberando sua mente para a letra."
    }
};

// Funções de Utilidade
function getRandomItem(array) {
    return array[Math.floor(Math.random() * array.length)];
}

function formatDate(date) {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleDateString('pt-BR', options);
}

function saveToLocalStorage(key, value) {
    try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
    } catch (e) {
        console.error('Erro ao salvar no localStorage:', e);
        return false;
    }
}

function getFromLocalStorage(key) {
    try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : null;
    } catch (e) {
        console.error('Erro ao recuperar do localStorage:', e);
        return null;
    }
}

// Função para abrir modal
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'block';
    }
}

// Função para fechar modal
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}

// Gerenciamento de Estatísticas
const stats = {
    // Função simplificada, sem estatísticas reais
    update(type, value = 1) {
        // Apenas para manter a compatibilidade com o código existente
        return {};
    },
    
    // Função vazia já que removemos a seção de estatísticas
    display() {
        // Não faz nada
    }
};

// Gerenciamento de Histórico
const history = {
    load() {
        return getFromLocalStorage('tocaAgoraHistory') || [];
    },
    
    save(challenge) {
        const currentHistory = this.load();
        challenge.date = new Date().toISOString();
        
        // Limitar histórico a 10 itens
        if (currentHistory.length >= 10) {
            currentHistory.pop(); // Remove o mais antigo
        }
        
        currentHistory.unshift(challenge); // Adiciona o novo no início
        saveToLocalStorage('tocaAgoraHistory', currentHistory);
    },
    
    display() {
        const historyList = document.querySelector('.history-list');
        historyList.innerHTML = ''; // Limpa o conteúdo atual
        
        const currentHistory = this.load();
        
        if (currentHistory.length === 0) {
            historyList.innerHTML = '<p>Você ainda não gerou nenhum desafio. Comece agora!</p>';
            return;
        }
        
        currentHistory.forEach((item, index) => {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            const date = new Date(item.date);
            
            historyItem.innerHTML = `
                <div class="history-date">${formatDate(date)}</div>
                <div class="history-content">
                    <div><strong>Música:</strong> ${item.cifra.title} - ${item.cifra.artist}</div>
                    <div><strong>Ritmo:</strong> ${item.ritmo.name}</div>
                    <div><strong>Missão:</strong> ${item.missao.title}</div>
                    <button class="btn secondary-btn restore-btn" data-index="${index}">Restaurar este desafio</button>
                </div>
            `;
            
            historyList.appendChild(historyItem);
        });
        
        // Adicionar evento aos botões de restaurar
        document.querySelectorAll('.restore-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = parseInt(e.target.dataset.index);
                const challenge = currentHistory[index];
                loadChallenge(challenge);
                closeModal('historyModal');
            });
        });
    }
};

// Funções para Geração de Desafio
function generateChallenge() {
    // Selecionar items aleatoriamente do banco de dados
    const cifra = getRandomItem(database.cifras);
    const ritmo = getRandomItem(database.ritmos);
    const missao = getRandomItem(database.missoes);
    
    // Criar objeto de desafio
    const challenge = {
        cifra: cifra,
        ritmo: ritmo,
        missao: missao,
        dateGenerated: new Date().toISOString()
    };
    
    // Salvar no histórico
    history.save(challenge);
    
    return challenge;
}

function loadChallenge(challenge) {
    // Exibir data atual
    const currentDateElement = document.getElementById('currentDate');
    currentDateElement.textContent = formatDate(new Date());
    
    // Preencher cifra
    document.getElementById('cifraTitle').textContent = challenge.cifra.title;
    document.getElementById('cifraArtist').textContent = challenge.cifra.artist;
    document.getElementById('cifraGenre').textContent = challenge.cifra.genre;
    document.getElementById('cifraTonality').textContent = `Tom: ${challenge.cifra.tonality}`;
    document.getElementById('cifraDifficulty').textContent = challenge.cifra.difficulty;
    document.getElementById('cifraDisplay').textContent = challenge.cifra.preview;
    
    // Preparar modal de cifra completa
    document.getElementById('modalCifraTitle').textContent = challenge.cifra.title;
    document.getElementById('fullCifraContent').textContent = challenge.cifra.full;
    
    // Carregar diagramas de acordes principais
    loadChordDiagrams(challenge.cifra.preview, 'mainChords');
    loadChordDiagrams(challenge.cifra.full, 'allChords');
    
    // Preencher ritmo
    document.getElementById('rhythmName').textContent = challenge.ritmo.name;
    
    const rhythmNotation = document.getElementById('rhythmNotation');
    rhythmNotation.innerHTML = ''; // Limpar
    
    // Criar representação visual do ritmo
    const beats = challenge.ritmo.notation.split(' ');
    beats.forEach(beat => {
        const span = document.createElement('span');
        span.className = 'beat';
        span.textContent = beat;
        
        // Se for um batida para baixo no início, adicionar classe accent
        if (beat.includes('↓') && !beat.includes('↑')) {
            span.classList.add('accent');
        }
        
        rhythmNotation.appendChild(span);
    });
    
    document.getElementById('rhythmDescription').textContent = challenge.ritmo.description;
    document.getElementById('tempoValue').textContent = challenge.ritmo.bpm;
    document.getElementById('tempoSlider').value = challenge.ritmo.bpm;
    
    // Configurar o modal de tutorial de ritmo
    setupRhythmTutorial(challenge.ritmo.name);
    
    // Iniciar animação do ritmo
    startRhythmAnimation(challenge.ritmo.notation);
    
    // Preencher missão
    document.getElementById('missionTitle').textContent = challenge.missao.title;
    document.getElementById('missionDescription').textContent = challenge.missao.description;
    
    const missionStepsList = document.getElementById('missionSteps');
    missionStepsList.innerHTML = ''; // Limpar
    
    // Criar lista de passos da missão
    challenge.missao.steps.forEach(step => {
        const li = document.createElement('li');
        li.textContent = step;
        missionStepsList.appendChild(li);
    });
    
    // Adicionar dica específica para a missão
    if (database.missionTips[challenge.missao.title]) {
        document.getElementById('missionTip').textContent = database.missionTips[challenge.missao.title];
    } else {
        document.getElementById('missionTip').textContent = "A consistência é mais importante que o tempo de prática. Melhor 20 minutos todos os dias do que 3 horas uma vez por semana!";
    }
    
    // Configurar o temporizador com o tempo da missão
    const timerValue = document.getElementById('timerValue');
    const minutes = challenge.missao.timeInMinutes;
    timerValue.textContent = `${minutes}:00`;
    timerValue.dataset.totalSeconds = minutes * 60;
    
    // Mostrar o container de resultado
    document.getElementById('result-container').classList.remove('hidden');
    
    // Atualizar estatísticas
    stats.update();
    stats.display();
    
    // Salvar desafio atual
    saveToLocalStorage('currentChallenge', challenge);
    
    // Rolar até os resultados
    document.getElementById('result-container').scrollIntoView({ behavior: 'smooth' });
}

// Função para extrair nomes de acordes de uma string de cifra
function extractChords(cifra) {
    // Lista de acordes conhecidos no nosso banco de dados
    const knownChords = Object.keys(database.chordDiagrams);
    
    // Expressão regular para encontrar os acordes
    const chordRegex = new RegExp('\\b(' + knownChords.join('|') + ')\\b', 'g');
    
    // Encontrar todos os acordes na cifra
    const matches = cifra.match(chordRegex);
    
    // Remover duplicatas
    if (matches) {
        return [...new Set(matches)];
    }
    
    return [];
}

// Função para carregar diagramas de acordes
function loadChordDiagrams(cifra, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    const chords = extractChords(cifra);
    
    chords.forEach(chordName => {
        const chord = database.chordDiagrams[chordName];
        if (chord) {
            const diagram = createChordDiagram(chord);
            diagram.addEventListener('click', () => openChordViewer(chord));
            container.appendChild(diagram);
        }
    });
}

// Função para criar um diagrama de acorde visual
function createChordDiagram(chord) {
    const diagramContainer = document.createElement('div');
    diagramContainer.className = 'chord-diagram';
    
    const name = document.createElement('div');
    name.className = 'chord-name';
    name.textContent = chord.name;
    diagramContainer.appendChild(name);
    
    const grid = document.createElement('div');
    grid.className = 'chord-grid';
    
    // Adicionar as cordas
    for (let i = 0; i < 6; i++) {
        const string = document.createElement('div');
        string.className = 'string';
        grid.appendChild(string);
    }
    
    // Adicionar os pontos para os dedos
    for (let i = 0; i < chord.positions.length; i++) {
        const position = chord.positions[i];
        
        // Pular cordas que não são tocadas
        if (position === -1) {
            const mute = document.createElement('div');
            mute.className = 'mute';
            mute.textContent = 'x';
            mute.style.left = `${i * 10 + 5}px`;
            grid.appendChild(mute);
            continue;
        }
        
        // Corda tocada solta
        if (position === 0) {
            const open = document.createElement('div');
            open.className = 'open';
            open.textContent = 'o';
            open.style.left = `${i * 10 + 5}px`;
            grid.appendChild(open);
            continue;
        }
        
        // Posição normal do dedo
        const dot = document.createElement('div');
        dot.className = 'dot';
        dot.style.left = `${i * 10 + 5}px`;
        dot.style.top = `${position * 13 + 7}px`;
        grid.appendChild(dot);
    }
    
    // Adicionar pestanas se houver
    chord.barres.forEach(barre => {
        const barreEl = document.createElement('div');
        barreEl.className = 'barre';
        barreEl.style.top = `${barre.fret * 13 + 7}px`;
        barreEl.style.left = `${(barre.fromString - 1) * 10 + 5}px`;
        barreEl.style.width = `${(barre.toString - barre.fromString) * 10}px`;
        barreEl.style.height = '8px';
        barreEl.style.backgroundColor = 'var(--secondary-color)';
        barreEl.style.borderRadius = '4px';
        barreEl.style.position = 'absolute';
        barreEl.style.zIndex = '1';
        grid.appendChild(barreEl);
    });
    
    diagramContainer.appendChild(grid);
    return diagramContainer;
}

// Função para configurar o tutorial de ritmo
function setupRhythmTutorial(rhythmName) {
    const tutorial = database.rhythmTutorials[rhythmName];
    if (!tutorial) return;
    
    document.getElementById('modalRhythmTitle').textContent = `Tutorial: Ritmo ${rhythmName}`;
    document.getElementById('tutorialRhythmDesc').textContent = tutorial.description;
    
    const stepsList = document.getElementById('rhythmSteps');
    stepsList.innerHTML = '';
    
    tutorial.steps.forEach(step => {
        const li = document.createElement('li');
        li.textContent = step;
        stepsList.appendChild(li);
    });
    
    const tipsList = document.getElementById('rhythmTips');
    tipsList.innerHTML = '';
    
    tutorial.tips.forEach(tip => {
        const li = document.createElement('li');
        li.textContent = tip;
        tipsList.appendChild(li);
    });
    
    setupRhythmAnimation('tutorialRhythmAnimation', tutorial.animation);
}

// Função para iniciar animação do ritmo
function startRhythmAnimation(notation) {
    const handIcon = document.querySelector('.guitar-hand-icon i');
    const beats = notation.split(' ');
    let currentBeatIndex = 0;
    
    // Parar qualquer animação existente
    if (window.rhythmAnimationInterval) {
        clearInterval(window.rhythmAnimationInterval);
    }
    
    // Iniciar nova animação
    window.rhythmAnimationInterval = setInterval(() => {
        const currentBeat = beats[currentBeatIndex];
        
        handIcon.className = 'fas fa-hand-paper';
        void handIcon.offsetWidth; // Truque para reiniciar a animação
        
        if (currentBeat.includes('↓')) {
            handIcon.classList.add('down');
        } else if (currentBeat.includes('↑')) {
            handIcon.classList.add('up');
        }
        
        currentBeatIndex = (currentBeatIndex + 1) % beats.length;
    }, 500);
}

// Função para configurar a animação do ritmo em um elemento específico
function setupRhythmAnimation(containerId, notation) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '';
    
    const beats = notation.split(' ');
    beats.forEach((beat, index) => {
        const indicator = document.createElement('div');
        indicator.className = 'stroke-indicator';
        if (beat.includes('↓')) {
            indicator.innerHTML = '<i class="fas fa-arrow-down"></i>';
        } else if (beat.includes('↑')) {
            indicator.innerHTML = '<i class="fas fa-arrow-up"></i>';
        }
        
        // Se for o primeiro ou um acento especial, marcamos como acento
        if (index === 0 || beat.includes('↓↑') || beat.includes('↑↓')) {
            indicator.classList.add('accent');
        }
        
        container.appendChild(indicator);
    });
}

// Função para abrir o visualizador de acordes
function openChordViewer(chord) {
    document.getElementById('modalChordName').textContent = `Acorde ${chord.name}`;
    
    // Criar o diagrama ampliado
    const container = document.getElementById('chordDiagramLarge');
    container.innerHTML = '';
    
    const grid = document.createElement('div');
    grid.className = 'chord-grid';
    
    // Adicionar as cordas
    for (let i = 0; i < 6; i++) {
        const string = document.createElement('div');
        string.className = 'string';
        grid.appendChild(string);
    }
    
    // Adicionar os pontos para os dedos
    for (let i = 0; i < chord.positions.length; i++) {
        const position = chord.positions[i];
        const finger = chord.fingers[i];
        
        // Pular cordas que não são tocadas ou soltas
        if (position === -1) continue;
        
        const dot = document.createElement('div');
        dot.className = 'dot';
        dot.style.left = `${i * 10 + 5}px`;
        dot.style.top = `${position * 13 + 7}px`;
        
        // Adicionar número do dedo se disponível
        if (finger > 0) {
            dot.textContent = finger;
        }
        
        grid.appendChild(dot);
    }
    
    // Adicionar pestanas se houver
    chord.barres.forEach(barre => {
        const barreEl = document.createElement('div');
        barreEl.className = 'barre';
        barreEl.style.top = `${barre.fret * 13 + 7}px`;
        barreEl.style.left = `${(barre.fromString - 1) * 10 + 5}px`;
        barreEl.style.width = `${(barre.toString - barre.fromString) * 10}px`;
        barreEl.style.height = '8px';
        barreEl.style.backgroundColor = 'var(--secondary-color)';
        barreEl.style.borderRadius = '4px';
        barreEl.style.position = 'absolute';
        barreEl.style.zIndex = '1';
        grid.appendChild(barreEl);
    });
    
    container.appendChild(grid);
    
    // Criar tabela de posição dos dedos
    const table = document.createElement('table');
    table.innerHTML = `
        <tr>
            <th>Corda</th>
            <th>Casa</th>
            <th>Dedo</th>
        </tr>
    `;
    
    // Preencher a tabela com informações dos dedos
    for (let i = 0; i < chord.positions.length; i++) {
        const position = chord.positions[i];
        const finger = chord.fingers[i];
        
        // Pular cordas que não são tocadas ou soltas
        if (position <= 0) continue;
        
        const row = document.createElement('tr');
        
        const stringCell = document.createElement('td');
        stringCell.textContent = 6 - i; // Invertendo a numeração das cordas (6 a 1)
        row.appendChild(stringCell);
        
        const fretCell = document.createElement('td');
        fretCell.textContent = position;
        row.appendChild(fretCell);
        
        const fingerCell = document.createElement('td');
        
        if (finger > 0) {
            const fingerNames = ["", "Indicador", "Médio", "Anelar", "Mínimo"];
            fingerCell.textContent = `${finger} (${fingerNames[finger]})`;
        } else {
            fingerCell.textContent = "—";
        }
        
        row.appendChild(fingerCell);
        table.appendChild(row);
    }
    
    document.getElementById('fingerPositionsTable').innerHTML = '';
    document.getElementById('fingerPositionsTable').appendChild(table);
    
    // Abrir o modal
    openModal('chordViewerModal');
}

// Função para exibir o badge de conclusão
function showCompletionBadge(show = true) {
    const badge = document.getElementById('completionBadge');
    if (show) {
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

// Também precisamos definir o objeto shareChallenge, que é usado nos botões de compartilhamento
function shareChallenge() {
    const currentChallenge = getFromLocalStorage('currentChallenge');
    if (!currentChallenge) return 'Desafio de Violão';
    
    return `🎸 Meu desafio de violão de hoje:\n\nMúsica: ${currentChallenge.cifra.title} - ${currentChallenge.cifra.artist}\nRitmo: ${currentChallenge.ritmo.name}\nMissão: ${currentChallenge.missao.title}\n\nAprendendo violão com o Kit Violão Profissional!`;
}

// Objetos para metrônomo e temporizador
const metronome = {
    interval: null,
    isPlaying: false,
    audioContext: null,
    tempo: 80,
    clickBuffers: {}, // Para armazenar sons pré-carregados
    
    initAudio() {
        if (!this.audioContext) {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            // Pré-carregar os sons de clique do violão
            this.loadSounds();
        }
    },
    
    loadSounds() {
        // Carregar som de corda de violão para tempo forte (Accent)
        // Usando E4 (Mi agudo) - 329.63 Hz
        this.createGuitarSound('high', 329.63);
        // Carregar som para tempo fraco (Regular beat)
        // Usando A3 (Lá) - 220.00 Hz
        this.createGuitarSound('low', 220.00);
    },
    
    createGuitarSound(type, frequency) {
        const buffer = this.audioContext.createBuffer(1, this.audioContext.sampleRate * 0.3, this.audioContext.sampleRate); // Increased duration slightly to 0.3s
        const data = buffer.getChannelData(0);
        
        // Parâmetros que fazem o som parecer com cordas de violão
        // Adjusted decay for a slightly longer, more natural sound
        const decay = type === 'high' ? 0.9996 : 0.9994;
        const attackTime = type === 'high' ? 0.002 : 0.003;
        
        // Gerar uma forma de onda que simula uma corda de violão
        for (let i = 0; i < buffer.length; i++) {
            // Ataque inicial da corda
            const attack = i < attackTime * this.audioContext.sampleRate ? 
                i / (attackTime * this.audioContext.sampleRate) : 1;
                
            // Componentes harmônicos da corda de violão
            const fundamental = Math.sin(2 * Math.PI * frequency * i / this.audioContext.sampleRate);
            // Increased amplitude of the first harmonic
            const harmonic1 = 0.6 * Math.sin(2 * Math.PI * frequency * 2 * i / this.audioContext.sampleRate); 
            const harmonic2 = 0.3 * Math.sin(2 * Math.PI * frequency * 3 * i / this.audioContext.sampleRate);
            const harmonic3 = 0.1 * Math.sin(2 * Math.PI * frequency * 4 * i / this.audioContext.sampleRate);
            
            // Combinar os harmônicos
            const sum = fundamental + harmonic1 + harmonic2 + harmonic3;
            
            // Aplicar envelope ADSR simplificado (ataque-decaimento)
            data[i] = sum * attack * Math.pow(decay, i);
        }
        
        this.clickBuffers[type] = buffer;
    },
    
    playClick(isAccent = false) {
        if (!this.audioContext) return;
        
        // Usar som diferente para tempo forte vs tempo fraco
        const bufferType = isAccent ? 'high' : 'low';
        const buffer = this.clickBuffers[bufferType];
        
        if (!buffer) return; // Se o som ainda não foi carregado
        
        const source = this.audioContext.createBufferSource();
        const gainNode = this.audioContext.createGain();
        
        source.buffer = buffer;
        source.connect(gainNode);
        gainNode.connect(this.audioContext.destination);
        
        // Volume um pouco mais alto para o tempo forte
        gainNode.gain.value = isAccent ? 0.6 : 0.4;
        
        source.start();
    },
    
    start(bpm) {
        this.initAudio();
        this.tempo = bpm;
        
        if (this.isPlaying) {
            this.stop();
            return;
        }
        
        this.isPlaying = true;
        document.getElementById('toggleMetronome').innerHTML = '<i class="fas fa-stop"></i>';
        
        let beat = 0;
        this.playClick(true); // Primeira batida é sempre acentuada
        
        const intervalTime = 60000 / this.tempo;
        
        this.interval = setInterval(() => {
            beat = (beat + 1) % 4;
            this.playClick(beat === 0); // Acentuar apenas o primeiro tempo de cada compasso
        }, intervalTime);
    },
    
    stop() {
        this.isPlaying = false;
        document.getElementById('toggleMetronome').innerHTML = '<i class="fas fa-play"></i>';
        
        if (this.interval) {
            clearInterval(this.interval);
            this.interval = null;
        }
    },
    
    updateTempo(bpm) {
        this.tempo = bpm;
        document.getElementById('tempoValue').textContent = bpm;
        
        if (this.isPlaying) {
            this.stop();
            this.start(bpm);
        }
    }
};

const timer = {
    interval: null,
    totalSeconds: 0,
    initialSeconds: 0,
    isRunning: false,
    
    start(minutes) {
        if (this.isRunning) {
            return;
        }
        
        this.initialSeconds = minutes * 60;
        this.totalSeconds = this.initialSeconds;
        
        const timerDisplay = document.querySelector('.timer-display');
        timerDisplay.classList.remove('hidden');
        
        this.isRunning = true;
        this.updateDisplay();
        
        this.interval = setInterval(() => {
            this.totalSeconds--;
            
            if (this.totalSeconds <= 0) {
                this.stop();
                alert('Tempo da missão concluído!');
                return;
            }
            
            this.updateDisplay();
        }, 1000);
    },
    
    pause() {
        if (!this.isRunning) {
            return;
        }
        
        this.isRunning = false;
        clearInterval(this.interval);
    },
    
    reset() {
        this.pause();
        this.totalSeconds = this.initialSeconds;
        this.updateDisplay();
    },
    
    updateDisplay() {
        const minutes = Math.floor(this.totalSeconds / 60);
        const seconds = this.totalSeconds % 60;
        const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        document.getElementById('timerValue').textContent = display;
    }
};

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado, inicializando aplicação...');
    
    // Carregar e exibir estatísticas
    stats.display();
    
    // Verificar se há um desafio atual salvo
    const currentChallenge = getFromLocalStorage('currentChallenge');
    if (currentChallenge) {
        loadChallenge(currentChallenge);
    }
    
    // --- Event Listeners ---
    
    // Gerar novo desafio
    const generateBtn = document.getElementById('generateBtn');
    if (generateBtn) {
        generateBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Gerando novo desafio...');
            const newChallenge = generateChallenge();
            loadChallenge(newChallenge);
        });
    }
    
    // Abrir modal de histórico (verificando se o botão existe)
    const historyBtn = document.getElementById('historyBtn');
    if (historyBtn) {
        historyBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Abrindo histórico...');
            history.display(); // Atualizar a lista antes de mostrar
            openModal('historyModal');
        });
    }
    
    // Ver cifra completa
    const viewFullCifraBtn = document.getElementById('viewFullCifraBtn');
    if (viewFullCifraBtn) {
        viewFullCifraBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Abrindo cifra completa...');
            openModal('cifraModal');
        });
    }
    
    // Fechar modais ao clicar no botão de fechar
    document.querySelectorAll('.modal-close').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Fechando modal...');
            const modal = this.closest('.modal');
            if (modal) {
                modal.style.display = 'none';
            }
        });
    });
    
    // Fechar modais ao clicar fora do conteúdo
    window.addEventListener('click', function(event) {
        document.querySelectorAll('.modal').forEach(modal => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
    
    // Metrônomo
    const toggleMetronome = document.getElementById('toggleMetronome');
    if (toggleMetronome) {
        toggleMetronome.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Toggle metrônomo...');
            const bpm = parseInt(document.getElementById('tempoSlider').value);
            metronome.start(bpm);
        });
    }
    
    const tempoSlider = document.getElementById('tempoSlider');
    if (tempoSlider) {
        tempoSlider.addEventListener('input', function() {
            const bpm = parseInt(this.value);
            metronome.updateTempo(bpm);
        });
    }
    
    // Temporizador
    const startTimer = document.getElementById('startTimer');
    if (startTimer) {
        startTimer.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Iniciando temporizador...');
            const currentChallenge = getFromLocalStorage('currentChallenge');
            if (currentChallenge) {
                timer.start(currentChallenge.missao.timeInMinutes);
            }
        });
    }
    
    const pauseTimer = document.getElementById('pauseTimer');
    if (pauseTimer) {
        pauseTimer.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Pausando temporizador...');
            timer.pause();
        });
    }
    
    const resetTimer = document.getElementById('resetTimer');
    if (resetTimer) {
        resetTimer.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Resetando temporizador...');
            timer.reset();
        });
    }
    
    // Tutorial de ritmo
    const viewRhythmTutorial = document.getElementById('viewRhythmTutorial');
    if (viewRhythmTutorial) {
        viewRhythmTutorial.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Abrindo tutorial de ritmo...');
            openModal('rhythmTutorialModal');
        });
    }
    
    // Marcar missão como concluída
    const missionComplete = document.getElementById('missionComplete');
    if (missionComplete) {
        missionComplete.addEventListener('change', function() {
            if (this.checked) {
                console.log('Missão completada!');
                stats.update('mission');
                stats.display();
                showCompletionBadge(true);
                
                // Remover a exibição do badge após 5 segundos
                setTimeout(() => {
                    showCompletionBadge(false);
                }, 5000);
                
                // Feedback visual e sonoro
                alert('Parabéns por completar a missão! Suas estatísticas foram atualizadas.');
            } else {
                showCompletionBadge(false);
            }
        });
    }
    
    // Delegação de eventos para botões de restaurar no histórico
    const historyList = document.querySelector('.history-list');
    if (historyList) {
        historyList.addEventListener('click', function(e) {
            if (e.target && e.target.matches('.restore-btn')) {
                e.preventDefault();
                const index = parseInt(e.target.dataset.index);
                const currentHistory = history.load();
                const challenge = currentHistory[index];
                loadChallenge(challenge);
                closeModal('historyModal');
            }
        });
    }

    // Atualizar os event listeners para os botões de compartilhamento
    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const platform = this.dataset.platform;
            const text = shareChallenge();
            
            let url;
            switch (platform) {
                case 'whatsapp':
                    url = `https://wa.me/?text=${encodeURIComponent(text)}`;
                    break;
                case 'telegram':
                    url = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(text)}`;
                    break;
                case 'facebook':
                    url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(text)}`;
                    break;
                case 'twitter':
                    url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
                    break;
                case 'email':
                    url = `mailto:?subject=Desafio de Violão&body=${encodeURIComponent(text)}`;
                    break;
                default:
                    return;
            }
            
            window.open(url, '_blank');
        });
    });
});