<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treino Personalizado IA</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #8B4513; /* Saddle Brown */
            --secondary-color: #A0522D; /* Sienna */
            --accent-color: #CD853F; /* Peru */
            --dark-color: #3E2723; /* Dark Brown */
            --light-color: #FFF8E1; /* Light Cream */
            --light-bg: #FDF5E6; /* Old Lace */
            --card-bg: #FFFFFF;
            --border-color: #E0D8C7;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --radius: 10px;
            --shadow: 0 5px 15px rgba(62, 39, 35, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--dark-color);
            background-color: var(--light-bg);
            line-height: 1.6;
            font-size: 16px;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--light-color);
            padding: 2rem 0;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        main > section {
            margin-bottom: 2rem;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        h2 {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        h3 {
            font-size: 1.4rem;
            color: var(--secondary-color);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .assessment-intro {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            color: var(--dark-color);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: calc(var(--radius) / 2);
            font-family: inherit;
            font-size: 1rem;
            background-color: #fff;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.2);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .checkbox-item label {
            font-weight: 400;
            margin-bottom: 0;
            font-size: 0.95rem;
            cursor: pointer;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.8rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: calc(var(--radius) / 2);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            gap: 0.5rem;
            text-decoration: none;
            font-size: 1rem;
        }

        .btn-lg {
            font-size: 1.1rem;
            padding: 1rem 2rem;
            margin-top: 1rem;
        }

        .btn-sm {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(62, 39, 35, 0.2);
        }

        .btn i {
            font-size: 1.1em;
        }

        .hidden {
            display: none !important;
        }

        #loading-section {
            text-align: center;
            padding: 3rem 0;
        }

        #loading-section i {
            font-size: 3rem;
            color: var(--primary-color);
            animation: spin 1.5s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #dashboard-section .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .progress-bar-container {
            height: 10px;
            background-color: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%; /* Will be set by JS */
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }

        .skill-progress {
            margin-bottom: 1rem;
        }

        .skill-progress .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .skill-progress .progress-label strong {
            font-weight: 600;
        }

        .skill-progress .progress-label span {
            color: var(--secondary-color);
        }

        .exercise-item {
            background-color: var(--light-bg);
            padding: 1rem;
            border-radius: calc(var(--radius) / 2);
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .exercise-item.completed {
            background-color: rgba(40, 167, 69, 0.1);
            border-color: var(--success-color);
        }

        .exercise-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .exercise-item h4 {
            margin: 0 0 0.3rem 0;
            font-size: 1.1rem;
            color: var(--dark-color);
        }
        
        .exercise-item p {
            margin: 0;
            font-size: 0.9rem;
            color: #555;
        }

        .exercise-item .tag {
            display: inline-block;
            font-size: 0.8rem;
            padding: 0.15rem 0.5rem;
            border-radius: 12px;
            background-color: var(--accent-color);
            color: var(--light-color);
            margin-right: 0.5rem;
            margin-top: 0.5rem;
        }

        .exercise-actions {
            display: flex;
            gap: 0.5rem;
        }

        .exercise-actions button {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .exercise-actions button:hover {
            color: var(--accent-color);
            transform: scale(1.1);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            overflow-x: auto; /* Allow horizontal scrolling for tabs on small screens */
            padding-bottom: 5px; /* Add some space below scrollbar if it appears */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: var(--dark-color);
            transition: var(--transition);
            white-space: nowrap; /* Prevent tab text from wrapping */
        }

        .tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .tab:hover:not(.active) {
            border-bottom-color: var(--border-color);
        }
        
        /* Botão de retorno à tela inicial */
        .home-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 999;
            transition: all 0.3s ease;
            border: none;
        }
        
        .home-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }
        
        .home-btn i {
            font-size: 1.8rem;
        }

        footer {
            text-align: center;
            margin-top: 3rem;
            padding: 1.5rem 0;
            color: var(--secondary-color);
            border-top: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        /* Styles for Timer Modal */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            width: 80%;
            max-width: 400px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        #timer-display {
            font-size: 3rem;
            font-weight: 700;
            color: var(--dark-color);
            margin: 1.5rem 0;
        }

        .timer-controls button {
            margin: 0 0.5rem;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Styles for Details Modal */
        #details-modal .modal-content {
            max-width: 500px; /* Slightly wider for details */
            text-align: left;
        }

        #details-modal-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        #details-modal-content {
            font-size: 1rem;
            line-height: 1.7;
            color: var(--dark-color);
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }
            header p {
                font-size: 1rem;
            }
            .card {
                padding: 1.5rem;
            }
            h2 {
                font-size: 1.6rem;
            }
            h3 {
                font-size: 1.3rem;
            }
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 1rem; /* Reduce padding on smaller screens */
            }
            .modal-content {
                width: 90%; /* Increase width slightly for smaller screens */
            }
            .home-btn {
                width: 50px;
                height: 50px;
                bottom: 20px;
                right: 20px;
            }
            .home-btn i {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) { /* Add breakpoint for very small screens */
            header h1 {
                font-size: 1.6rem;
            }
            header p {
                font-size: 0.9rem;
            }
            h2 {
                font-size: 1.4rem;
            }
            h3 {
                font-size: 1.2rem;
            }
            .btn-lg {
                font-size: 1rem;
                padding: 0.8rem 1.5rem;
            }
            #timer-display {
                font-size: 2.5rem;
            }
            .tab {
                padding: 0.6rem 1rem; /* Reduce tab padding */
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <h1><i class="fas fa-guitar"></i> Treino Personalizado IA</h1>
            <p>Seu treinamento adaptativo para dominar o violão</p>
        </div>
    </header>

    <main class="container">

        <!-- Assessment Section -->
        <section id="assessment-section" class="card">
            <h2>Avaliação Completa para o Seu Plano Personalizado</h2>
            <p class="assessment-intro">Nossa IA precisa conhecer você melhor para criar o plano perfeito para o seu desenvolvimento. Por favor, responda com detalhes:</p>
            
            <button id="test-mode-btn" class="btn btn-sm" style="float: right; background-color: var(--info-color);">
                <i class="fas fa-vial"></i> Modo de Teste
            </button>
            
            <form id="assessment-form">
                <div class="form-group">
                    <label for="name">Seu nome:</label>
                    <input type="text" id="name" name="name" placeholder="Como podemos te chamar?" required>
                </div>

                <div class="form-group">
                    <label for="level">Qual seu nível atual no violão?</label>
                    <select id="level" name="level" required>
                        <option value="" disabled selected>Selecione seu nível</option>
                        <option value="iniciante_zero">Iniciante (nunca toquei)</option>
                        <option value="iniciante_basico">Iniciante (sei alguns acordes básicos)</option>
                        <option value="intermediario">Intermediário (troco acordes, toco músicas simples)</option>
                        <option value="intermediario_avancado">Intermediário Avançado (domino pestanas, ritmos variados)</option>
                        <option value="avancado">Avançado (busco técnicas específicas, improviso)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="experience">Há quanto tempo você toca violão? (em meses)</label>
                    <input type="number" id="experience" name="experience" min="0" max="600" placeholder="Ex: 6" required>
                </div>

                <div class="form-group">
                    <label for="practice-frequency">Com que frequência você consegue praticar?</label>
                    <select id="practice-frequency" name="practice_frequency" required>
                        <option value="" disabled selected>Selecione sua frequência</option>
                        <option value="daily">Todos os dias</option>
                        <option value="almost_daily">4-6 dias por semana</option>
                        <option value="few_days">2-3 dias por semana</option>
                        <option value="weekends">Apenas nos finais de semana</option>
                        <option value="irregular">Irregularmente</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="time">Quantos minutos por dia você pode praticar em média?</label>
                    <input type="number" id="time" name="time" min="10" max="180" placeholder="Ex: 30" required>
                </div>

                <div class="form-group">
                    <label for="goals">Quais seus principais objetivos? (Seja específico)</label>
                    <textarea id="goals" name="goals" rows="3" placeholder="Ex: Quero aprender a tocar músicas do Legião Urbana, desenvolver técnica de fingerpicking, tocar em rodas de amigos..." required></textarea>
                </div>

                <div class="form-group">
                    <label>Quais técnicas você já domina? (Selecione todas que se aplicam)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="tech-basic-chords" name="techniques" value="basic_chords">
                            <label for="tech-basic-chords">Acordes básicos (C, G, D, Am, Em)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tech-barre" name="techniques" value="barre_chords">
                            <label for="tech-barre">Acordes com pestana</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tech-strumming" name="techniques" value="strumming">
                            <label for="tech-strumming">Ritmos básicos (batidas)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tech-fingerpicking" name="techniques" value="fingerpicking">
                            <label for="tech-fingerpicking">Dedilhado (fingerstyle)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tech-scales" name="techniques" value="scales">
                            <label for="tech-scales">Escalas (pentatônicas, maiores, menores)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tech-improvisation" name="techniques" value="improvisation">
                            <label for="tech-improvisation">Improvisação</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="pain-points">Quais são suas maiores dificuldades ao tocar?</label>
                    <textarea id="pain-points" name="pain_points" rows="2" placeholder="Ex: Tenho dificuldade em fazer pestanas, manter o ritmo, trocar de acordes rapidamente..."></textarea>
                </div>

                <div class="form-group">
                    <label for="styles">Quais estilos musicais você mais gosta? (Selecione até 3)</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="style-mpb" name="music_styles" value="mpb">
                            <label for="style-mpb">MPB</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="style-rock" name="music_styles" value="rock">
                            <label for="style-rock">Rock</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="style-sertanejo" name="music_styles" value="sertanejo">
                            <label for="style-sertanejo">Sertanejo</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="style-pop" name="music_styles" value="pop">
                            <label for="style-pop">Pop</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="style-blues" name="music_styles" value="blues">
                            <label for="style-blues">Blues</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="style-classical" name="music_styles" value="classical">
                            <label for="style-classical">Clássico</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="style-jazz" name="music_styles" value="jazz">
                            <label for="style-jazz">Jazz</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="style-folk" name="music_styles" value="folk">
                            <label for="style-folk">Folk</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="artists">Artistas ou bandas favoritas (que você gostaria de tocar)</label>
                    <input type="text" id="artists" name="favorite_artists" placeholder="Ex: Toquinho, Beatles, Ana Carolina...">
                </div>

                <div class="form-group">
                    <label for="songs">Músicas específicas que gostaria de aprender a tocar:</label>
                    <textarea id="songs" name="target_songs" rows="2" placeholder="Ex: Wonderwall (Oasis), Pequena Serenata Diurna (Legião Urbana)..."></textarea>
                </div>

                <div class="form-group">
                    <label for="learning-style">Como você aprende melhor?</label>
                    <select id="learning-style" name="learning_style">
                        <option value="" disabled selected>Selecione seu estilo de aprendizado</option>
                        <option value="visual">Visual (vídeos, imagens, diagramas)</option>
                        <option value="auditory">Auditivo (explicações verbais, áudios)</option>
                        <option value="reading">Leitura (textos, partituras)</option>
                        <option value="practical">Prática (exercícios práticos, tentativa e erro)</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-lg">Gerar meu Plano Personalizado <i class="fas fa-brain"></i></button>
            </form>
        </section>

        <!-- Loading Section -->
        <section id="loading-section" class="hidden">
            <i class="fas fa-sync-alt"></i>
            <p>Analisando suas informações e criando seu plano personalizado...</p>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard-section" class="hidden">
            <div class="dashboard-header">
                <h2><i class="fas fa-user-circle"></i> Olá, <span id="user-name">Violonista</span>!</h2>
                <p>Seu plano personalizado foi criado com base no seu perfil e objetivos.</p>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="today">Plano de Hoje</div>
                <div class="tab" data-tab="week">Plano Semanal</div>
                <div class="tab" data-tab="month">Plano Mensal</div> <!-- Nova Aba -->
                <div class="tab" data-tab="progress">Meu Progresso</div>
                <div class="tab" data-tab="resources">Recursos</div>
            </div>
            
            <!-- Tab Content: Today -->
            <div class="tab-content" id="tab-today">
                <div class="card" id="todays-plan">
                    <h3><i class="fas fa-calendar-day"></i> Plano de Hoje (<span id="today-date"></span>)</h3>
                    <div class="session-timer">
                        <p>Tempo de prática sugerido hoje: <strong><span id="practice-time">30</span> minutos</strong></p>
                        <button class="btn btn-sm" id="start-session-btn"><i class="fas fa-play"></i> Iniciar Sessão</button>
                    </div>
                    <div id="exercises-container">
                        <p>Carregando seu plano de hoje...</p>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Weekly Plan -->
            <div class="tab-content hidden" id="tab-week">
                <div class="card">
                    <h3><i class="fas fa-calendar-week"></i> Plano Semanal Detalhado</h3>
                    <p class="weekly-intro">Foco da semana: <strong id="weekly-focus">Carregando...</strong></p> <!-- Added ID -->
                    <div id="weekly-plan-container">
                        <p>Carregando plano semanal...</p>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Monthly Plan (NOVO) -->
            <div class="tab-content hidden" id="tab-month">
                <div class="card">
                    <h3><i class="fas fa-calendar-alt"></i> Plano Mensal</h3>
                    <p>Visão geral dos seus objetivos e marcos para as próximas 4 semanas.</p>
                    <div id="monthly-plan-container">
                        <p>Carregando plano mensal...</p>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Progress -->
            <div class="tab-content hidden" id="tab-progress">
                <div class="grid">
                    <div class="card">
                        <h3>Progresso Geral</h3>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="overall-progress" style="width: 10%;"></div>
                        </div>
                        <p><small>Nível atual: <span id="current-level-display">Iniciante</span></small></p>
                        <p id="next-level-info">Próximo nível: <strong>Iniciante Básico</strong> (estimativa: 3 semanas)</p>
                    </div>
                    <div class="card">
                        <h3>Tempo de Prática</h3>
                        <div id="practice-stats">
                            <p>Esta semana: <strong>0 minutos</strong></p>
                            <p>Total acumulado: <strong>0 minutos</strong></p>
                            <p>Consistência: <strong>0%</strong></p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Habilidades Desenvolvidas</h3>
                    <div id="skills-progress">
                        <!-- Skills progress bars will be loaded here -->
                    </div>
                </div>
                
                <div class="card">
                    <h3>Próximos Objetivos</h3>
                    <div id="next-goals">
                        <p>Carregando seus próximos objetivos...</p>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Resources -->
            <div class="tab-content hidden" id="tab-resources">
                <div class="card">
                    <h3><i class="fas fa-book-open"></i> Recursos Recomendados</h3>
                    
                    <h4>Vídeos e Tutoriais</h4>
                    <div id="video-resources">
                        <p>Recursos de vídeo serão personalizados conforme você progride.</p>
                    </div>

                    <h4>Músicas Sugeridas</h4>
                    <div id="song-resources">
                        <p>Músicas sugeridas aparecerão aqui conforme você avança.</p>
                    </div>

                    <h4>Exercícios Técnicos</h4>
                    <div id="exercise-resources">
                        <p>Exercícios técnicos serão recomendados com base no seu progresso.</p>
                    </div>
                </div>
            </div>
            
            <!-- Botão para refazer a avaliação -->
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn" id="reset-assessment-btn"><i class="fas fa-redo"></i> Refazer Avaliação</button>
            </div>
        </section>

    </main>

    <!-- Timer Modal -->
    <div id="timer-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-timer-modal">&times;</span>
            <h3><i class="fas fa-clock"></i> Sessão de Prática</h3>
            <div id="timer-display">00:00</div>
            <div class="timer-controls">
                <button class="btn btn-sm" id="pause-timer-btn"><i class="fas fa-pause"></i> Pausar</button>
                <button class="btn btn-sm" id="reset-timer-btn"><i class="fas fa-redo"></i> Reiniciar</button>
            </div>
        </div>
    </div>

    <!-- Exercise Details Modal -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-details-modal">&times;</span>
            <h3 id="details-modal-title">Detalhes do Exercício</h3>
            <div id="details-modal-content">
                <p>Carregando detalhes...</p>
            </div>
        </div>
    </div>

    <a href="../index.html" class="home-btn" title="Voltar à Tela Inicial do Aplicativo">
        <i class="fas fa-home"></i>
    </a>

    <script>
        const assessmentSection = document.getElementById('assessment-section');
        const loadingSection = document.getElementById('loading-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const assessmentForm = document.getElementById('assessment-form');
        const todaysPlanContainer = document.getElementById('todays-plan');
        const overallProgress = document.getElementById('overall-progress');
        const currentLevelDisplay = document.getElementById('current-level-display');
        const userName = document.getElementById('user-name');
        const exercisesContainer = document.getElementById('exercises-container');
        const weeklyPlanContainer = document.getElementById('weekly-plan-container');
        const weeklyFocusElement = document.getElementById('weekly-focus'); // Added for weekly focus
        const monthlyPlanContainer = document.getElementById('monthly-plan-container'); // Added for monthly plan
        const nextGoals = document.getElementById('next-goals');
        const practiceTime = document.getElementById('practice-time');
        const todayDate = document.getElementById('today-date');
        const timerModal = document.getElementById('timer-modal');
        const closeTimerModalBtn = document.getElementById('close-timer-modal');
        const timerDisplay = document.getElementById('timer-display');
        const startSessionBtn = document.getElementById('start-session-btn');
        const pauseTimerBtn = document.getElementById('pause-timer-btn');
        const resetTimerBtn = document.getElementById('reset-timer-btn');
        const detailsModal = document.getElementById('details-modal');
        const closeDetailsModalBtn = document.getElementById('close-details-modal');
        const detailsModalTitle = document.getElementById('details-modal-title');
        const detailsModalContent = document.getElementById('details-modal-content');

        let timerInterval = null;
        let totalSeconds = 0;
        let remainingSeconds = 0;
        let isPaused = false;

        // --- Utility Functions ---
        function showSection(sectionId) {
            assessmentSection.classList.add('hidden');
            loadingSection.classList.add('hidden');
            dashboardSection.classList.add('hidden');

            const sectionToShow = document.getElementById(sectionId);
            if (sectionToShow) {
                sectionToShow.classList.remove('hidden');
            }
        }

        function saveUserData(data) {
            localStorage.setItem('guitarProPlanUser', JSON.stringify(data));
        }

        function loadUserData() {
            const data = localStorage.getItem('guitarProPlanUser');
            return data ? JSON.parse(data) : null;
        }

        // Formatar data em português
        function formatDate(date) {
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            return new Date(date).toLocaleDateString('pt-BR', options);
        }

        // Função para alternar entre as abas
        function switchTab(tabName) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remover classe active de todas as abas
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar a aba selecionada
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            // Adicionar classe active à aba selecionada
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
        }

        // Format seconds into MM:SS
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // --- Timer Functions ---
        function startTimer(durationMinutes) {
            totalSeconds = durationMinutes * 60;
            remainingSeconds = totalSeconds;
            isPaused = false;
            pauseTimerBtn.innerHTML = '<i class="fas fa-pause"></i> Pausar';
            updateTimerDisplay();
            clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                if (!isPaused && remainingSeconds > 0) {
                    remainingSeconds--;
                    updateTimerDisplay();
                } else if (remainingSeconds === 0) {
                    clearInterval(timerInterval);
                    alert("Sessão de prática concluída!");
                    // Optionally close modal or give other feedback
                    timerModal.style.display = 'none'; 
                }
            }, 1000);
        }

        function pauseTimer() {
            isPaused = !isPaused;
            pauseTimerBtn.innerHTML = isPaused ? '<i class="fas fa-play"></i> Retomar' : '<i class="fas fa-pause"></i> Pausar';
        }

        function resetTimer() {
            clearInterval(timerInterval);
            remainingSeconds = totalSeconds;
            isPaused = false;
            pauseTimerBtn.innerHTML = '<i class="fas fa-pause"></i> Pausar';
            updateTimerDisplay();
            // Restart the timer immediately after reset
            startTimer(totalSeconds / 60);
        }

        function updateTimerDisplay() {
            timerDisplay.textContent = formatTime(remainingSeconds);
        }

        // --- "AI" Simulation Aprimorado ---
        function generatePlan(userData) {
            console.log("Generating plan for:", userData);
            
            // Plano personalizado com base nos dados do usuário
            let plan = {
                today: [],
                weekly: [],
                monthly: [], // Novo campo para plano mensal
                weeklyFocus: "", // Renomeado de 'focus' para clareza
                suggestions: [],
                progress: 10, // Progresso inicial
                skills: [], // Habilidades para desenvolver
                nextGoals: [] // Próximos objetivos
            };

            // Definir tempo de prática recomendado (usando o tempo informado pelo usuário)
            plan.practiceTime = userData.time || 30;

            // Inicialização dos dias da semana
            const weekdays = ['Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado', 'Domingo'];
            const dailyTime = Math.max(15, Math.floor(userData.time / 2)); // Tempo base por dia
            const weekendTime = Math.max(20, Math.floor(userData.time * 0.75)); // Tempo para fim de semana

            // Aquecimento básico para todos os níveis
            plan.today.push({ 
                id: 'warmup1', 
                title: "Aquecimento de Dedos", 
                description: "Exercício 1-2-3-4 em todas as cordas", 
                duration_minutes: 5, // Added duration
                completed: false,
                details: "Posicione os dedos 1, 2, 3 e 4 em sequência nas casas da mesma corda, mantendo os dedos pressionados. Faça o exercício em todas as cordas subindo e descendo."
            });

            // Exercícios principais baseados no nível do usuário
            switch (userData.level) {
                case 'iniciante_zero':
                    // Exercícios para quem nunca tocou
                    plan.today.push({ 
                        id: 'ex1', 
                        title: "Postura e Pegada", 
                        description: "Revisar postura correta e como segurar o violão", // Removed time from description
                        duration_minutes: 5, // Added duration
                        completed: false,
                        details: "Sente-se em uma cadeira sem braços, mantenha as costas retas. O violão deve descansar na perna direita (para destros) e o braço deve estar em um ângulo confortável."
                    });
                    plan.today.push({ 
                        id: 'ex2', 
                        title: "Acorde Em", 
                        description: "Aprender e praticar o acorde Em", // Removed time from description
                        duration_minutes: 10, // Added duration
                        completed: false,
                        details: "O Em é um dos acordes mais simples. Posicione o dedo 2 na 2ª casa da 5ª corda e o dedo 3 na 2ª casa da 4ª corda. Toque todas as cordas e ouça o som."
                    });
                    plan.today.push({ 
                        id: 'ex3', 
                        title: "Conhecendo o Violão", 
                        description: "Aprender os nomes das cordas e partes do violão", // Removed time from description
                        duration_minutes: 5, // Added duration
                        completed: false,
                        details: "As cordas do violão se chamam, de cima para baixo: Mi (1ª), Si (2ª), Sol (3ª), Ré (4ª), Lá (5ª) e Mi (6ª). Familiarize-se com as partes: corpo, braço, trastes, cabeça."
                    });
                    
                    // Foco da semana
                    plan.weeklyFocus = "Familiarização com o instrumento e primeiros acordes";
                    
                    // Progresso
                    plan.progress = 5;
                    
                    // Sugestões
                    plan.suggestions.push({ id: 'sug1', title: "Vídeo: Postura Correta para Iniciantes", link: "https://www.youtube.com/results?search_query=postura+correta+viol%C3%A3o+iniciante" });
                    plan.suggestions.push({ id: 'sug2', title: "Música Simples: Asa Branca (Em, Am)", link: "https://www.youtube.com/results?search_query=asa+branca+violao+facil" });
                    
                    // Habilidades para desenvolver
                    plan.skills = [
                        {name: "Postura Correta", progress: 0},
                        {name: "Acordes Básicos", progress: 0},
                        {name: "Coordenação Motora", progress: 0}
                    ];
                    
                    // Próximos objetivos
                    plan.nextGoals = [
                        "Dominar os acordes Em e Am",
                        "Conseguir trocar entre os dois acordes",
                        "Aprender a tocar uma melodia simples"
                    ];
                    
                    // Plano semanal DETALHADO
                    plan.weekly = [
                        {day: "Segunda", focus: "Postura e acorde Em", time: `${dailyTime} min`},
                        {day: "Terça", focus: "Repetir exercícios de segunda + Cordas Soltas", time: `${dailyTime} min`},
                        {day: "Quarta", focus: "Introdução ao acorde Am", time: `${dailyTime} min`},
                        {day: "Quinta", focus: "Transição lenta entre Em e Am", time: `${dailyTime} min`},
                        {day: "Sexta", focus: "Revisão dos acordes e postura", time: `${dailyTime} min`},
                        {day: "Sábado", focus: "Tentar tocar ritmo simples em Em e Am", time: `${weekendTime} min`},
                        {day: "Domingo", focus: "Descanso ou prática livre (revisar nomes das cordas)", time: "optativo"}
                    ];

                    // Plano Mensal (Exemplo)
                    plan.monthly = [
                        { week: "Semana 1", focus: "Fundamentos: Postura, Acordes Em/Am", goal: "Tocar Em e Am com som limpo" },
                        { week: "Semana 2", focus: "Novos Acordes: C e G", goal: "Aprender C e G e iniciar transições" },
                        { week: "Semana 3", focus: "Transições e Ritmo Básico", goal: "Trocar entre 4 acordes e fazer 1 ritmo" },
                        { week: "Semana 4", focus: "Primeira Música Simples", goal: "Tocar uma música de 2-3 acordes" }
                    ];
                    break;

                case 'iniciante_basico':
                    // Exercícios para quem já conhece alguns acordes
                    plan.today.push({ 
                        id: 'ex1', 
                        title: "Transição C → G → D", 
                        description: "Praticar a troca entre C, G e D", // Removed time from description
                        duration_minutes: Math.max(10, Math.floor(userData.time / 3)), // Added duration
                        completed: false,
                        details: "Pratique a troca entre esses acordes. Primeiro lentamente, garantindo que todos os dedos estejam na posição correta e todas as notas soem limpas. Gradualmente aumente o tempo."
                    });
                    plan.today.push({ 
                        id: 'ex2', 
                        title: "Ritmo Básico (Pop/MPB)", 
                        description: "Praticar batida ↓↓↑↑↓↑", // Removed time from description
                        duration_minutes: Math.max(10, Math.floor(userData.time / 3)), // Added duration
                        completed: false,
                        details: "Com o acorde C, pratique a batida: baixo (↓), baixo (↓), cima (↑), cima (↑), baixo (↓), cima (↑). Use somente o dedão para os baixos e todos os dedos para as batidas para cima."
                    });
                    plan.today.push({ 
                        id: 'ex3', 
                        title: "Música Simples", 
                        description: "Tocar 'Pra Não Dizer Que Não Falei das Flores'", // Removed time from description
                        duration_minutes: Math.max(10, Math.floor(userData.time / 3)), // Added duration
                        completed: false,
                        details: "Esta música usa basicamente G, C e D. Perfeita para praticar a transição entre acordes com um ritmo simples. Acompanhe com a música para trabalhar o tempo."
                    });
                    
                    // Foco da semana
                    plan.weeklyFocus = "Fluidez na troca de acordes básicos e ritmos";
                    
                    // Progresso
                    plan.progress = 25;
                    
                    // Sugestões
                    plan.suggestions.push({ id: 'sug1', title: "Vídeo: Transição de Acordes para Iniciantes", link: "https://www.youtube.com/results?search_query=transi%C3%A7%C3%A3o+de+acordes+viol%C3%A3o+iniciante" });
                    plan.suggestions.push({ id: 'sug2', title: "Música: 'Pra Não Dizer Que Não Falei das Flores'", link: "https://www.youtube.com/results?search_query=pra+n%C3%A3o+dizer+que+n%C3%A3o+falei+das+flores+viol%C3%A3o+iniciante" });
                    plan.suggestions.push({ id: 'sug3', title: "Vídeo: 4 ritmos essenciais no violão", link: "https://www.youtube.com/results?search_query=ritmos+essenciais+viol%C3%A3o" });
                    
                    // Habilidades
                    plan.skills = [
                        {name: "Acordes Básicos", progress: 30},
                        {name: "Ritmos (Batidas)", progress: 20},
                        {name: "Transição de Acordes", progress: 15}
                    ];
                    
                    // Próximos objetivos
                    plan.nextGoals = [
                        "Conseguir trocar entre C, G e D sem pausas",
                        "Dominar 2 ritmos básicos",
                        "Tocar uma música completa acompanhando a gravação"
                    ];
                    
                    // Plano semanal DETALHADO
                    plan.weekly = [
                        {day: "Segunda", focus: "Transição C-G-D (lento)", time: `${dailyTime} min`},
                        {day: "Terça", focus: "Prática de ritmo ↓↓↑↑↓↑", time: `${dailyTime} min`},
                        {day: "Quarta", focus: "Combinar acordes C-G com ritmo", time: `${dailyTime} min`},
                        {day: "Quinta", focus: "Tocar 'Pra Não Dizer...' (parte 1)", time: `${dailyTime} min`},
                        {day: "Sexta", focus: "Tocar 'Pra Não Dizer...' (completa, lento)", time: `${dailyTime} min`},
                        {day: "Sábado", focus: "Tocar junto com a gravação (velocidade reduzida)", time: `${weekendTime} min`},
                        {day: "Domingo", focus: "Revisão ou aprender novo ritmo simples", time: "optativo"}
                    ];

                    // Plano Mensal (Exemplo)
                    plan.monthly = [
                        { week: "Semana 1", focus: "Fluidez C-G-D e Ritmo Pop", goal: "Tocar sequência C-G-D com ritmo sem parar" },
                        { week: "Semana 2", focus: "Introdução à Pestana (F)", goal: "Conseguir montar o F, mesmo que não soe perfeito" },
                        { week: "Semana 3", focus: "Prática de Pestana e Nova Música", goal: "Melhorar som da pestana e tocar música com F" },
                        { week: "Semana 4", focus: "Revisão e Ritmos Variados", goal: "Dominar 3 ritmos e tocar 2 músicas completas" }
                    ];
                    break;

                case 'intermediario':
                    // Exercícios para nível intermediário
                    plan.today.push({ 
                        id: 'ex1', 
                        title: "Acordes com Pestana", 
                        description: "Praticar os acordes F, Bm e B7", // Removed time from description
                        duration_minutes: Math.max(15, Math.floor(userData.time / 4)), // Added duration
                        completed: false,
                        details: "Trabalhe a força e precisão da pestana. Para o F, pressione todas as cordas na 1ª casa com o dedo 1, posicione o dedo 2 na 2ª casa da 3ª corda, dedo 3 na 3ª casa da 5ª corda e dedo 4 na 3ª casa da 4ª corda."
                    });
                    plan.today.push({ 
                        id: 'ex2', 
                        title: "Escala Pentatônica de Am", 
                        description: "Praticar a escala pentatônica de Lá menor", // Removed time from description
                        duration_minutes: Math.max(10, Math.floor(userData.time / 4)), // Added duration
                        completed: false,
                        details: "Comece da 5ª casa da 6ª corda (E) e siga o padrão da pentatônica menor. Pratique subindo e descendo lentamente, garantindo que cada nota soe clara."
                    });
                    plan.today.push({ 
                        id: 'ex3', 
                        title: "Técnica de Palhetada Alternada", 
                        description: "Praticar palhetada alternada na 1ª corda", // Removed time from description
                        duration_minutes: Math.max(10, Math.floor(userData.time / 4)), // Added duration
                        completed: false,
                        details: "Com a palheta, toque a 1ª corda alternando entre movimentos para baixo e para cima. Comece devagar e aumente gradualmente a velocidade, mantendo o ritmo constante."
                    });
                    plan.today.push({ 
                        id: 'ex4', 
                        title: "Aplicação: House of the Rising Sun", 
                        description: "Praticar a progressão Am-C-D-F-Am-E-Am", // Removed time from description
                        duration_minutes: Math.max(15, Math.floor(userData.time / 4)), // Added duration
                        completed: false,
                        details: "Esta música clássica combina acordes básicos e pestanas com arpejo. Pratique a sequência de acordes primeiro, depois tente o padrão de dedilhado característico da música."
                    });
                    
                    // Foco da semana
                    plan.weeklyFocus = "Domínio de pestanas e introdução a escalas";
                    
                    // Progresso
                    plan.progress = 45;
                    
                    // Sugestões
                    plan.suggestions.push({ id: 'sug1', title: "Vídeo: Dominando Pestanas", link: "https://www.youtube.com/results?search_query=como+fazer+pestana+viol%C3%A3o" });
                    plan.suggestions.push({ id: 'sug2', title: "Música: House of the Rising Sun Tutorial", link: "https://www.youtube.com/results?search_query=house+of+the+rising+sun+violao+tutorial" });
                    plan.suggestions.push({ id: 'sug3', title: "Exercício: Escala Pentatônica Am", link: "https://www.youtube.com/results?search_query=escala+pentatonica+am+viol%C3%A3o" });
                    
                    // Habilidades
                    plan.skills = [
                        {name: "Acordes com Pestana", progress: 30},
                        {name: "Escalas Pentatônicas", progress: 25},
                        {name: "Técnica de Palhetada", progress: 20},
                        {name: "Dedilhado (Arpejo)", progress: 15}
                    ];
                    
                    // Próximos objetivos
                    plan.nextGoals = [
                        "Dominar os acordes com pestana F, Bm e B7",
                        "Conseguir tocar a escala pentatônica de Am fluidamente",
                        "Tocar 'House of the Rising Sun' com o ritmo correto"
                    ];
                    
                    // Plano semanal DETALHADO
                    plan.weekly = [
                        {day: "Segunda", focus: "Exercícios de força para pestana (F, Bm)", time: `${dailyTime} min`},
                        {day: "Terça", focus: "Escala Pentatônica Am (padrão 1)", time: `${dailyTime} min`},
                        {day: "Quarta", focus: "Palhetada alternada em escalas", time: `${dailyTime} min`},
                        {day: "Quinta", focus: "Progressão 'House of the Rising Sun' (acordes)", time: `${dailyTime} min`},
                        {day: "Sexta", focus: "Dedilhado/Arpejo em 'House of the Rising Sun'", time: `${dailyTime} min`},
                        {day: "Sábado", focus: "Tocar 'House of the Rising Sun' completa", time: `${weekendTime} min`},
                        {day: "Domingo", focus: "Improviso básico com Pentatônica Am", time: "optativo"}
                    ];

                    // Plano Mensal (Exemplo)
                    plan.monthly = [
                        { week: "Semana 1", focus: "Pestanas (F, Bm) e Pentatônica Am", goal: "Tocar F e Bm com som limpo e escala Am fluente" },
                        { week: "Semana 2", focus: "Fingerstyle Básico e Nova Música", goal: "Aprender padrão PIMA e música com fingerstyle" },
                        { week: "Semana 3", focus: "Escala Maior (C) e Teoria", goal: "Dominar padrão da escala maior e entender intervalos" },
                        { week: "Semana 4", focus: "Improvisação e Aplicação", goal: "Improvisar sobre backing track e aplicar escalas em músicas" }
                    ];
                    break;

                case 'intermediario_avancado':
                    // Exercícios para intermediário avançado
                    plan.today.push({ 
                        id: 'ex1', 
                        title: "Acordes com Tensões", 
                        description: "Praticar acordes maj7, 7(9), m7", // Removed time from description
                        duration_minutes: Math.max(15, Math.floor(userData.time / 4)), // Added duration
                        completed: false,
                        details: "Pratique Cmaj7, G7(9), Dm7. Estes acordes adicionam cores à sua harmonia. Trabalhe nas transições entre eles e escute as diferenças de sonoridade."
                    });
                    plan.today.push({ 
                        id: 'ex2', 
                        title: "Técnica: Ligados e Pull-offs", 
                        description: "Exercícios de ligados ascendentes e descendentes", // Removed time from description
                        duration_minutes: Math.max(10, Math.floor(userData.time / 4)), // Added duration
                        completed: false,
                        details: "Na mesma corda, posicione os dedos 1 e 3 em casas separadas por duas. Toque a nota mais baixa e, sem palheta, pressione a casa mais alta (ligado). Depois, faça o inverso (pull-off)."
                    });
                    plan.today.push({ 
                        id: 'ex3', 
                        title: "Introdução ao Fingerstyle", 
                        description: "Padrão p-i-m-a em progressão Am-F-C-G", // Removed time from description
                        duration_minutes: Math.max(15, Math.floor(userData.time / 4)), // Added duration
                        completed: false,
                        details: "Use o polegar (p) para as cordas 6,5,4, e os dedos indicador (i), médio (m) e anelar (a) para as cordas 3,2,1 respectivamente. Toque o polegar seguido dos outros dedos em sequência."
                    });
                    plan.today.push({ 
                        id: 'ex4', 
                        title: "Música: Tears in Heaven", 
                        description: "Estudo dos acordes e padrão de dedilhado", // Removed time from description
                        duration_minutes: Math.max(15, Math.floor(userData.time / 4)), // Added duration
                        completed: false,
                        details: "Esta música de Eric Clapton é perfeita para prática de fingerstyle intermediário. Foque primeiro nos acordes, depois no padrão de dedilhado específico da música."
                    });
                    
                    // Foco da semana
                    plan.weeklyFocus = "Técnicas avançadas e fingerstyle";
                    
                    // Progresso
                    plan.progress = 65;
                    
                    // Sugestões
                    plan.suggestions.push({ id: 'sug1', title: "Vídeo: Acordes com Tensões na Prática", link: "https://www.youtube.com/results?search_query=acordes+com+tens%C3%B5es+viol%C3%A3o" });
                    plan.suggestions.push({ id: 'sug2', title: "Tutorial: Tears in Heaven - Eric Clapton", link: "https://www.youtube.com/results?search_query=tears+in+heaven+tutorial+viol%C3%A3o" });
                    plan.suggestions.push({ id: 'sug3', title: "Exercícios: Ligados e Pull-offs", link: "https://www.youtube.com/results?search_query=ligados+e+pull+offs+viol%C3%A3o+exercicios" });
                    
                    // Habilidades
                    plan.skills = [
                        {name: "Acordes Avançados", progress: 60},
                        {name: "Técnicas Expressivas", progress: 50},
                        {name: "Fingerstyle", progress: 40},
                        {name: "Harmonia Aplicada", progress: 45}
                    ];
                    
                    // Próximos objetivos
                    plan.nextGoals = [
                        "Dominar a técnica de ligados e pull-offs",
                        "Conseguir tocar o padrão de fingerstyle fluidamente",
                        "Tocar 'Tears in Heaven' em andamento moderado"
                    ];
                    
                    // Plano semanal DETALHADO
                    plan.weekly = [
                        {day: "Segunda", focus: "Acordes com tensões e transições", time: `${dailyTime} min`},
                        {day: "Terça", focus: "Técnicas de ligados e pull-offs", time: `${dailyTime} min`},
                        {day: "Quarta", focus: "Introdução ao fingerstyle", time: `${dailyTime} min`},
                        {day: "Quinta", focus: "Prática de 'Tears in Heaven' - acordes", time: `${dailyTime} min`},
                        {day: "Sexta", focus: "Prática de 'Tears in Heaven' - dedilhado", time: `${dailyTime} min`},
                        {day: "Sábado", focus: "Integração de técnicas e música completa", time: `${weekendTime} min`},
                        {day: "Domingo", focus: "Sessão livre ou composição", time: "optativo"}
                    ];

                    // Plano Mensal (Exemplo)
                    plan.monthly = [
                        { week: "Semana 1", focus: "Tensões, Ligados/Pull-offs, Fingerstyle (PIMA)", goal: "Dominar técnicas e aplicar em progressões" },
                        { week: "Semana 2", focus: "Música Fingerstyle Complexa (ex: Tears in Heaven)", goal: "Tocar a música completa com fluidez" },
                        { week: "Semana 3", focus: "Modos Gregos (Introdução)", goal: "Entender e aplicar modos Dórico e Mixolídio" },
                        { week: "Semana 4", focus: "Improvisação Modal e Composição", goal: "Improvisar usando modos e compor pequena peça" }
                    ];
                    break;

                case 'avancado':
                    // Exercícios para nível avançado
                    plan.today.push({ 
                        id: 'ex1', 
                        title: "Técnica: Tapping", 
                        description: "Introdução ao tapping em duas cordas", // Removed time from description
                        duration_minutes: Math.max(15, Math.floor(userData.time / 4)), // Added duration
                        completed: false,
                        details: "Use a mão direita para 'martelar' (tap) notas no braço além das que você está segurando com a mão esquerda. Pratique sequências simples usando as cordas 1 e 2."
                    });
                    plan.today.push({ 
                        id: 'ex2', 
                        title: "Improviso sobre II-V-I", 
                        description: "Praticar improviso sobre progressão Dm7-G7-Cmaj7", // Removed time from description
                        duration_minutes: Math.max(15, Math.floor(userData.time / 4)), // Added duration
                        completed: false,
                        details: "Usando a escala de Dó maior e modos relacionados, pratique frases melódicas sobre esta progressão. Foque em notas-alvo e construção de frases musicais."
                    });
                    plan.today.push({ 
                        id: 'ex3', 
                        title: "Fingerstyle Avançado", 
                        description: "Estudo de 'Blackbird' dos Beatles", // Removed time from description
                        duration_minutes: Math.max(15, Math.floor(userData.time / 4)), // Added duration
                        completed: false,
                        details: "Esta música combina linha de baixo e melodia simultaneamente. Trabalhe nas partes separadamente primeiro, depois junte-as lentamente."
                    });
                    plan.today.push({ 
                        id: 'ex4', 
                        title: "Composição", 
                        description: "Desenvolvimento de ideias musicais próprias", // Removed time from description
                        duration_minutes: Math.max(15, Math.floor(userData.time / 4)), // Added duration
                        completed: false,
                        details: "Crie progressões de acordes originais ou desenvolva melodias. Grave suas ideias no celular para não esquecê-las. Explore combinações de acordes incomuns."
                    });
                    
                    // Foco da semana
                    plan.weeklyFocus = "Técnicas avançadas e expressividade musical";
                    
                    // Progresso
                    plan.progress = 80;
                    
                    // Sugestões
                    plan.suggestions.push({ id: 'sug1', title: "Vídeo: Introdução ao Tapping no Violão", link: "https://www.youtube.com/results?search_query=tapping+viol%C3%A3o+tutorial" });
                    plan.suggestions.push({ id: 'sug2', title: "Tutorial: Blackbird - The Beatles", link: "https://www.youtube.com/results?search_query=blackbird+the+beatles+tutorial+viol%C3%A3o" });
                    plan.suggestions.push({ id: 'sug3', title: "Estudo: Improvisação sobre II-V-I", link: "https://www.youtube.com/results?search_query=improvisa%C3%A7%C3%A3o+II+V+I+viol%C3%A3o" });
                    
                    // Habilidades
                    plan.skills = [
                        {name: "Técnicas Avançadas", progress: 75},
                        {name: "Improvisação", progress: 70},
                        {name: "Composição", progress: 65},
                        {name: "Fingerstyle Avançado", progress: 80},
                        {name: "Expressão Musical", progress: 75}
                    ];
                    
                    // Próximos objetivos
                    plan.nextGoals = [
                        "Desenvolver técnica de tapping para solos",
                        "Criar solos improvisados sobre progressões comuns",
                        "Dominar a execução completa de 'Blackbird'",
                        "Compor uma música autoral completa"
                    ];
                    
                    // Plano semanal DETALHADO
                    plan.weekly = [
                        {day: "Segunda", focus: "Técnica de tapping", time: `${dailyTime + 5} min`},
                        {day: "Terça", focus: "Improviso sobre II-V-I", time: `${dailyTime + 5} min`},
                        {day: "Quarta", focus: "Fingerstyle: Blackbird (parte 1)", time: `${dailyTime + 5} min`},
                        {day: "Quinta", focus: "Fingerstyle: Blackbird (parte 2)", time: `${dailyTime + 5} min`},
                        {day: "Sexta", focus: "Composição e desenvolvimento de ideias", time: `${dailyTime + 10} min`},
                        {day: "Sábado", focus: "Tocar 'Blackbird' completa + Improviso Livre", time: `${weekendTime + 10} min`},
                        {day: "Domingo", focus: "Gravação e Análise do progresso", time: "optativo"}
                    ];

                    // Plano Mensal (Exemplo)
                    plan.monthly = [
                        { week: "Semana 1", focus: "Tapping, Improviso II-V-I, Música Complexa (Parte 1)", goal: "Dominar licks de tapping e improvisar sobre II-V-I" },
                        { week: "Semana 2", focus: "Música Complexa (Completa), Harmonia Quartal", goal: "Tocar música avançada e entender harmonia quartal" },
                        { week: "Semana 3", focus: "Técnicas Híbridas (Palheta + Dedos), Modos Avançados", goal: "Aplicar técnicas híbridas e modos Lídio/Frígio" },
                        { week: "Semana 4", focus: "Composição Avançada / Arranjo", goal: "Compor peça instrumental ou arranjar música existente" }
                    ];
                    break;

                // Caso o nível não seja especificado
                default:
                    plan.today.push({ 
                        id: 'ex1', 
                        title: "Revisão Geral", 
                        description: "Revise acordes e técnicas que você já conhece", // Removed time from description
                        duration_minutes: 15, // Added duration
                        completed: false,
                        details: "Faça um inventário de todos os acordes e técnicas que você já domina. Identifique aqueles que precisam de mais prática."
                    });
                    plan.today.push({ 
                        id: 'ex2', 
                        title: "Técnica Livre", 
                        description: "Escolha uma técnica para focar hoje", // Removed time from description
                        duration_minutes: 15, // Added duration
                        completed: false,
                        details: "Selecione uma técnica específica que você quer melhorar e dedique tempo focado apenas nela."
                    });
                    
                    plan.weeklyFocus = "Avaliação e Definição de Metas";
                    plan.weekly = weekdays.map(day => ({ day: day, focus: "Prática Livre / Revisão", time: `${dailyTime} min` }));
                    plan.monthly = [
                        { week: "Semana 1", focus: "Autoavaliação e Definição de Objetivos", goal: "Criar plano de estudo claro" },
                        { week: "Semana 2", focus: "Revisão de Fundamentos", goal: "Solidificar acordes e técnicas básicas" },
                        { week: "Semana 3", focus: "Exploração de Novos Tópicos", goal: "Identificar áreas de interesse para focar" },
                        { week: "Semana 4", focus: "Planejamento do Próximo Mês", goal: "Definir metas específicas para o mês seguinte" }
                    ];
            }

            // Adiciona um elemento divertido se o tempo permitir
            if (userData.time >= 30 && userData.level !== 'avancado') {
                plan.today.push({ 
                    id: 'fun1', 
                    title: "Momento Música", 
                    description: "Escolha e toque uma música que você goste", // Removed time from description
                    duration_minutes: Math.max(10, userData.time - 30), // Added duration
                    completed: false,
                    details: "Escolha uma música que você goste e já saiba tocar, ou experimente tocar uma nova. O objetivo é se divertir e aplicar o que você aprendeu."
                });
            }

            // Personalização baseada no estilo musical preferido do usuário
            if (userData.music_styles) {
                let styles = Array.isArray(userData.music_styles) ? userData.music_styles : [userData.music_styles];
                
                if (styles.includes('mpb') || styles.includes('sertanejo')) {
                    plan.suggestions.push({ 
                        id: 'style1', 
                        title: `Batidas de ${styles.includes('mpb') ? 'MPB' : 'Sertanejo'}`, 
                        link: `https://www.youtube.com/results?search_query=batidas+${styles.includes('mpb') ? 'mpb' : 'sertanejo'}+violao` 
                    });
                }
                
                if (styles.includes('rock')) {
                    plan.suggestions.push({ 
                        id: 'style2', 
                        title: "Power Chords para Rock", 
                        link: "https://www.youtube.com/results?search_query=power+chords+violao+rock" 
                    });
                }
                
                if (styles.includes('blues')) {
                    plan.suggestions.push({ 
                        id: 'style3', 
                        title: "Introdução ao Blues no Violão", 
                        link: "https://www.youtube.com/results?search_query=blues+basico+violao" 
                    });
                }
            }

            // Personalização baseada nas dificuldades reportadas
            if (userData.pain_points && userData.pain_points.includes('pestana')) {
                plan.suggestions.push({ 
                    id: 'pain1', 
                    title: "Exercícios para Dominar Pestanas", 
                    link: "https://www.youtube.com/results?search_query=exercicios+pestana+violao" 
                });
            }

            // Personalização baseada nos artistas favoritos
            if (userData.favorite_artists) {
                plan.suggestions.push({ 
                    id: 'artist1', 
                    title: `Aprenda a tocar ${userData.favorite_artists.split(',')[0]}`, 
                    link: `https://www.youtube.com/results?search_query=como+tocar+${userData.favorite_artists.split(',')[0].trim().replace(' ', '+')}+violao` 
                });
            }

            return plan;
        }

        // --- UI Update Functions ---
        function displayDashboard(userData, planData) {
            // Atualizar nome do usuário
            userName.textContent = userData.name || "Violonista";
            
            // Atualizar data de hoje
            todayDate.textContent = formatDate(new Date());
            
            // Atualizar tempo de prática recomendado
            practiceTime.textContent = planData.practiceTime || userData.time || 30;

            // Exibir plano de hoje
            exercisesContainer.innerHTML = '';
            if (planData.today && planData.today.length > 0) {
                planData.today.forEach(item => {
                    const completedIcon = item.completed ? '<i class="fas fa-check-circle" style="color: var(--success-color);"></i>' : '<i class="far fa-circle"></i>';
                    // Updated to remove the type tag and use duration_minutes
                    exercisesContainer.innerHTML += `
                        <div class="exercise-item ${item.completed ? 'completed' : ''}" data-id="${item.id}">
                            <div>
                                <h4>${item.title} <span class="tag">${item.duration_minutes} min</span></h4> 
                                <p>${item.description}</p>
                            </div>
                            <div class="exercise-actions">
                                <button onclick="toggleTaskComplete('${item.id}')" title="${item.completed ? 'Desmarcar' : 'Marcar como concluída'}">
                                    ${completedIcon} <!-- Moved icon inside button -->
                                </button>
                                <button onclick="showExerciseDetails('${item.id}')" title="Mais detalhes">
                                    <i class="fas fa-info-circle"></i> <!-- Added icon for details -->
                                </button>
                            </div>
                        </div>
                    `;
                });
            } else {
                exercisesContainer.innerHTML = '<p>Nenhuma tarefa para hoje. Revise seus objetivos ou gere um novo plano.</p>';
            }

            // Exibir foco semanal
            weeklyFocusElement.textContent = planData.weeklyFocus || "Não definido";

            // Exibir plano semanal DETALHADO
            weeklyPlanContainer.innerHTML = '';
            if (planData.weekly && planData.weekly.length > 0) {
                planData.weekly.forEach(day => {
                    // Check if exercises exist for the day
                    const exercisesHtml = day.exercises && Array.isArray(day.exercises) ? `
                        <div class="day-exercises">
                            <h5><i class="fas fa-dumbbell"></i> Exercícios:</h5>
                            <ul>
                                ${day.exercises.map(ex => `
                                    <li>
                                        <strong>${ex.title || 'Exercício'}</strong> 
                                        ${ex.duration ? `<span class="tag">${ex.duration}</span>` : ''}
                                        <p>${ex.description || ''}</p>
                                        ${ex.details ? `<p class="exercise-details-small"><i class="fas fa-info-circle"></i> ${ex.details}</p>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : '';

                    // Check if goals exist for the day
                    const goalsHtml = day.goals && Array.isArray(day.goals) ? `
                        <div class="day-goals">
                            <h5><i class="fas fa-bullseye"></i> Objetivos do Dia:</h5>
                            <ul>
                                ${day.goals.map(goal => `<li>${goal}</li>`).join('')}
                            </ul>
                        </div>
                    ` : '';

                    // Check if notes exist for the day
                    const notesHtml = day.notes ? `
                        <div class="day-notes">
                            <h5><i class="fas fa-sticky-note"></i> Notas:</h5>
                            <p>${day.notes}</p>
                        </div>
                    ` : '';

                    weeklyPlanContainer.innerHTML += `
                        <div class="exercise-item weekly-day">
                            <div>
                                <h4><i class="far fa-calendar-alt"></i> ${day.day}</h4>
                                <div class="day-focus">
                                    <p><strong><i class="fas fa-crosshairs"></i> Foco:</strong> ${day.focus}</p>
                                    <p><i class="fas fa-clock"></i> Tempo Sugerido: <strong>${day.time}</strong></p>
                                </div>
                                ${exercisesHtml}
                                ${goalsHtml}
                                ${notesHtml}
                            </div>
                        </div>
                    `;
                });
            } else {
                weeklyPlanContainer.innerHTML = '<p>Plano semanal indisponível. Por favor, atualize seu perfil.</p>';
            }

            // Exibir plano mensal (NOVO e MAIS DETALHADO)
            monthlyPlanContainer.innerHTML = '';
            if (planData.monthly && planData.monthly.length > 0) {
                // Add monthly overview if available
                if (planData.monthlyGoals && Array.isArray(planData.monthlyGoals)) {
                    monthlyPlanContainer.innerHTML += `
                        <div class="monthly-overview">
                            <h4><i class="fas fa-mountain"></i> Visão Geral do Mês</h4>
                            <div class="monthly-goals">
                                <h5>Objetivos Principais:</h5>
                                <ul>
                                    ${planData.monthlyGoals.map(goal => `<li>${goal}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }

                planData.monthly.forEach(week => {
                    // Generate key exercises HTML if available
                    const keyExercisesHtml = week.keyExercises && Array.isArray(week.keyExercises) ? `
                        <div class="week-key-exercises">
                            <h5><i class="fas fa-key"></i> Exercícios-Chave:</h5>
                            <ul>
                                ${week.keyExercises.map(ex => `
                                    <li>
                                        <strong>${ex.title}</strong>
                                        ${ex.description ? `<p>${ex.description}</p>` : ''}
                                        ${ex.technique ? `<span class="tag">${ex.technique}</span>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : '';

                    // Generate repertoire HTML if available
                    const repertoireHtml = week.repertoire && Array.isArray(week.repertoire) ? `
                        <div class="week-repertoire">
                            <h5><i class="fas fa-music"></i> Repertório Sugerido:</h5>
                            <ul>
                                ${week.repertoire.map(song => `<li>${song}</li>`).join('')}
                            </ul>
                        </div>
                    ` : '';

                    // Generate checkpoints HTML if available
                    const checkpointsHtml = week.checkpoints && Array.isArray(week.checkpoints) ? `
                        <div class="week-checkpoints">
                            <h5><i class="fas fa-flag-checkered"></i> Checkpoints:</h5>
                            <ul>
                                ${week.checkpoints.map(cp => `<li>${cp}</li>`).join('')}
                            </ul>
                        </div>
                    ` : '';

                    // Generate theory topics HTML if available
                    const theoryHtml = week.theoryTopics && Array.isArray(week.theoryTopics) ? `
                        <div class="week-theory">
                            <h5><i class="fas fa-book"></i> Fundamentos Teóricos:</h5>
                            <ul>
                                ${week.theoryTopics.map(topic => `<li>${topic}</li>`).join('')}
                            </ul>
                        </div>
                    ` : '';

                    monthlyPlanContainer.innerHTML += `
                        <div class="exercise-item monthly-week">
                            <div>
                                <h4><i class="fas fa-calendar-week"></i> ${week.week}</h4>
                                <div class="week-main-info">
                                    <p><strong><i class="fas fa-crosshairs"></i> Foco Principal:</strong> ${week.focus}</p>
                                    <p><strong><i class="fas fa-flag"></i> Meta da Semana:</strong> ${week.goal}</p>
                                </div>
                                ${keyExercisesHtml}
                                ${repertoireHtml}
                                ${checkpointsHtml}
                                ${theoryHtml}
                            </div>
                        </div>
                    `;
                });
            } else {
                monthlyPlanContainer.innerHTML = '<p>Plano mensal indisponível. Por favor, atualize seu perfil.</p>';
            }

            // Exibir progresso
            overallProgress.style.width = `${planData.progress}%`;
            currentLevelDisplay.textContent = userData.level ? userData.level.replace(/_/g, ' ') : 'Iniciante';

            // Exibir próximos objetivos
            nextGoals.innerHTML = '';
            if (planData.nextGoals && planData.nextGoals.length > 0) {
                const nextGoalsList = document.createElement('ul');
                planData.nextGoals.forEach(goal => {
                    const li = document.createElement('li');
                    li.textContent = goal;
                    nextGoalsList.appendChild(li);
                });
                nextGoals.appendChild(nextGoalsList);
            } else {
                nextGoals.innerHTML = '<p>Defina seus objetivos para visualizar seu caminho.</p>';
            }

            // Exibir habilidades
            const skillsProgress = document.getElementById('skills-progress');
            skillsProgress.innerHTML = '';
            if (planData.skills && planData.skills.length > 0) {
                planData.skills.forEach(skill => {
                    skillsProgress.innerHTML += `
                        <div class="skill-progress">
                            <div class="progress-label">
                                <strong>${skill.name}</strong>
                                <span>${skill.progress}%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${skill.progress}%; background-color: var(--accent-color);"></div>
                            </div>
                        </div>
                    `;
                });
           
            } else {
                 skillsProgress.innerHTML = '<p>Suas habilidades serão exibidas aqui conforme você progride.</p>';
            }

            // Exibir recursos recomendados (vídeos, músicas, exercícios)
            const videoResources = document.getElementById('video-resources');
            const songResources = document.getElementById('song-resources');
            const exerciseResources = document.getElementById('exercise-resources');
            
            videoResources.innerHTML = '';
            songResources.innerHTML = '';
            exerciseResources.innerHTML = '';

            let videoList = document.createElement('ul');
            let songList = document.createElement('ul');
            let exerciseList = document.createElement('ul');
            let hasVideos = false, hasSongs = false, hasExercises = false;

            if (planData.suggestions && planData.suggestions.length > 0) {
                planData.suggestions.forEach(sug => {
                    const li = document.createElement('li');
                    // Criar um link pesquisável no YouTube
                    const link = document.createElement('a');
                    link.href = sug.link || `https://www.youtube.com/results?search_query=${encodeURIComponent(sug.title + ' violao')}`;
                    link.textContent = sug.title;
                    link.target = "_blank"; // Abrir em nova aba
                    link.style.color = "var(--primary-color)";
                    link.style.textDecoration = "none";
                    li.appendChild(link);
                    
                    // Basic categorization based on title keywords
                    if (sug.title.toLowerCase().includes('vídeo') || sug.title.toLowerCase().includes('tutorial') || sug.title.toLowerCase().includes('introdução')) {
                        videoList.appendChild(li);
                        hasVideos = true;
                    } else if (sug.title.toLowerCase().includes('música') || sug.title.toLowerCase().includes('tocar')) {
                        songList.appendChild(li);
                        hasSongs = true;
                    } else if (sug.title.toLowerCase().includes('exercício') || sug.title.toLowerCase().includes('escala') || sug.title.toLowerCase().includes('técnica') || sug.title.toLowerCase().includes('pestana')) {
                        exerciseList.appendChild(li);
                        hasExercises = true;
                    } else {
                        // Default to videos if no keyword matches
                        videoList.appendChild(li);
                        hasVideos = true;
                    }
                });
            }
            
            if (hasVideos) {
                videoResources.appendChild(videoList);
            } else {
                videoResources.innerHTML = '<p>Recursos de vídeo serão personalizados conforme você progride.</p>';
            }
            
            if (hasSongs) {
                songResources.appendChild(songList);
            } else {
                songResources.innerHTML = '<p>Músicas sugeridas aparecerão aqui conforme você avança.</p>';
            }
            
            if (hasExercises) {
                exerciseResources.appendChild(exerciseList);
            } else {
                exerciseResources.innerHTML = '<p>Exercícios técnicos serão recomendados com base no seu progresso.</p>';
            }

            showSection('dashboard-section');
        }

        // --- Event Handlers ---
        function handleAssessmentSubmit(event) {
            // ... (código existente para coletar dados)
            event.preventDefault();
            showSection('loading-section');

            // Coletar todos os dados do formulário
            const formData = new FormData(assessmentForm);
            
            // Coletar checkboxes selecionados (técnicas e estilos musicais)
            const techniques = [];
            document.querySelectorAll('input[name="techniques"]:checked').forEach(checkbox => {
                techniques.push(checkbox.value);
            });
            
            const musicStyles = [];
            document.querySelectorAll('input[name="music_styles"]:checked').forEach(checkbox => {
                musicStyles.push(checkbox.value);
            });
            
            // Construir objeto com todos os dados do usuário
            const userData = {
                name: formData.get('name'),
                level: formData.get('level'),
                experience: parseInt(formData.get('experience'), 10) || 0,
                practice_frequency: formData.get('practice_frequency'),
                time: parseInt(formData.get('time'), 10) || 30,
                goals: formData.get('goals'),
                techniques: techniques,
                pain_points: formData.get('pain_points'),
                music_styles: musicStyles,
                favorite_artists: formData.get('favorite_artists'),
                target_songs: formData.get('target_songs'),
                learning_style: formData.get('learning_style'),
                lastUpdate: new Date().toISOString()
            };

            // Simular tempo de processamento da IA
            setTimeout(() => {
                const planData = generatePlan(userData);
                userData.currentPlan = planData; // Armazena o plano com os dados do usuário
                saveUserData(userData);
                displayDashboard(userData, planData);
            }, 1500); // Reduzido para 1.5 segundos
        }

        function toggleTaskComplete(taskId) {
            // ... (código existente para marcar tarefa)
            const userData = loadUserData();
            if (!userData || !userData.currentPlan) return;

            const taskIndex = userData.currentPlan.today.findIndex(task => task.id === taskId);
            if (taskIndex !== -1) {
                userData.currentPlan.today[taskIndex].completed = !userData.currentPlan.today[taskIndex].completed;

                // Atualização simples de progresso
                const completedTasks = userData.currentPlan.today.filter(t => t.completed).length;
                const totalTasks = userData.currentPlan.today.length;
                // Progresso base + incremento por tarefa
                let baseProgress = 10; // Ajustar conforme necessário
                 switch (userData.level) {
                    case 'iniciante_zero': baseProgress = 5; break;
                    case 'iniciante_basico': baseProgress = 20; break;
                    case 'intermediario': baseProgress = 40; break;
                    case 'intermediario_avancado': baseProgress = 60; break;
                    case 'avancado': baseProgress = 75; break;
                 }
                 // Calcula o progresso adicional baseado nas tarefas concluídas
                 let taskProgressIncrement = totalTasks > 0 ? (100 - baseProgress) / totalTasks : 0;
                 userData.currentPlan.progress = Math.round(baseProgress + (completedTasks * taskProgressIncrement));
                 // Garante que o progresso não ultrapasse 100
                 userData.currentPlan.progress = Math.min(100, userData.currentPlan.progress);

                saveUserData(userData);
                // Atualizar o item específico e a barra de progresso para feedback visual
                displayDashboard(userData, userData.currentPlan); // Re-renderizar todo o dashboard para simplicidade
            }
        }

        function showExerciseDetails(taskId) {
            // ... (código existente para mostrar detalhes)
            const userData = loadUserData();
            if (!userData || !userData.currentPlan) return;

            const task = userData.currentPlan.today.find(t => t.id === taskId);
            if (task) {
                detailsModalTitle.textContent = task.title || "Detalhes do Exercício";
                detailsModalContent.innerHTML = task.details ? `<p>${task.details.replace(/\n/g, '<br>')}</p>` : '<p>Nenhum detalhe adicional disponível.</p>';
                // Adicionar duração e tipo se disponíveis
                if (task.duration_minutes) {
                    detailsModalContent.innerHTML += `<p><strong>Duração Sugerida:</strong> ${task.duration_minutes} minutos</p>`;
                }
                if (task.type) {
                    detailsModalContent.innerHTML += `<p><strong>Tipo:</strong> ${task.type}</p>`;
                }
                detailsModal.style.display = 'flex'; // Show modal
            } else {
                // Fallback alert if task not found (shouldn't normally happen)
                alert(`Detalhes não encontrados para a tarefa ID: ${taskId}`);
            }
        }

        // --- Test Mode ---
        document.getElementById('test-mode-btn').addEventListener('click', () => {
            const testData = {
                name: "João Silva",
                level: "intermediario",
                experience: 12,
                practice_frequency: "daily",
                time: 60,
                goals: "Aprender fingerstyle e tocar músicas de MPB e Rock nacional.",
                techniques: ["basic_chords", "barre_chords", "strumming"],
                pain_points: "Dificuldade em pestanas e dedilhados complexos.",
                music_styles: ["mpb", "rock", "folk"],
                favorite_artists: "Toquinho, Legião Urbana, Pink Floyd",
                target_songs: "Yesterday (Beatles), Eduardo e Mônica (Legião), Romaria (Renato Teixeira)",
                learning_style: "visual"
            };

            // Preencher os campos de texto e select
            Object.keys(testData).forEach(key => {
                const input = document.querySelector(`[name="${key}"]`);
                if (input && input.type !== "checkbox") {
                    input.value = testData[key];
                }
            });

            // Marcar os checkboxes apropriados
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false; // Limpar todas as seleções primeiro
            });

            // Marcar técnicas
            testData.techniques.forEach(value => {
                const checkbox = document.querySelector(`[name="techniques"][value="${value}"]`);
                if (checkbox) checkbox.checked = true;
            });

            // Marcar estilos musicais
            testData.music_styles.forEach(value => {
                const checkbox = document.querySelector(`[name="music_styles"][value="${value}"]`);
                if (checkbox) checkbox.checked = true;
            });
        });

        // --- Tab Switching ---
        document.querySelectorAll('.tab').forEach(tabElement => {
            tabElement.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        // --- Botão de Iniciar Sessão (MODIFIED) ---
        startSessionBtn.addEventListener('click', function() {
            const userData = loadUserData();
            if (userData && userData.currentPlan) {
                const duration = userData.currentPlan.practiceTime || 30; // Get duration from plan or default
                timerModal.style.display = 'flex'; // Show modal
                startTimer(duration);
            } else {
                alert("Não foi possível iniciar a sessão. Gere seu plano primeiro.");
            }
        });

        // --- Timer Modal Controls ---
        closeTimerModalBtn.addEventListener('click', () => {
            clearInterval(timerInterval);
            timerModal.style.display = 'none';
        });

        pauseTimerBtn.addEventListener('click', pauseTimer);
        resetTimerBtn.addEventListener('click', resetTimer);

        // Close modal if clicked outside content
        window.addEventListener('click', (event) => {
            if (event.target == timerModal) {
                clearInterval(timerInterval);
                timerModal.style.display = 'none';
            }
        });

        // --- Details Modal Controls ---
        closeDetailsModalBtn.addEventListener('click', () => {
            detailsModal.style.display = 'none';
        });

        // Close details modal if clicked outside content
        window.addEventListener('click', (event) => {
            if (event.target == detailsModal) {
                detailsModal.style.display = 'none';
            }
            // Keep existing logic for timer modal
            if (event.target == timerModal) {
                clearInterval(timerInterval);
                timerModal.style.display = 'none';
            }
        });

        // --- Botão Refazer Avaliação ---
        document.getElementById('reset-assessment-btn').addEventListener('click', () => {
            showSection('assessment-section');
            // Opcional: Limpar o formulário ao voltar
            // assessmentForm.reset(); 
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const existingUserData = loadUserData();
            if (existingUserData && existingUserData.currentPlan) {
                // Se dados do usuário existem, mostrar dashboard diretamente
                console.log("Dados de usuário existentes encontrados, carregando dashboard.");
                // Opcional: Adicionar lógica para verificar se o plano está desatualizado e precisa ser regerado
                displayDashboard(existingUserData, existingUserData.currentPlan);
            } else {
                // Caso contrário, mostrar avaliação
                console.log("Nenhum dado de usuário encontrado, mostrando avaliação.");
                showSection('assessment-section');
            }

            // Adicionar ouvinte de evento ao formulário
            assessmentForm.addEventListener('submit', handleAssessmentSubmit);
        });

    </script>

</body>
</html>
